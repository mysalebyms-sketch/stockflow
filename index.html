<!DOCTYPE html>
<html lang="th">
<head>
  <!-- =================================================
       META / CONFIG
  ================================================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Stock Viewer v2</title>

  <!-- =================================================
       DESIGN TOKENS (LOCKED)
  ================================================== -->
  <style id="tokens">
    :root {
      /* colors */
      --primary: #2563EB;
      --success: #16A34A;
      --warning: #F59E0B;
      --danger:  #DC2626;

      --gray-900: #111827;
      --gray-600: #4B5563;
      --gray-400: #9CA3AF;
      --gray-200: #E5E7EB;
      --gray-100: #F3F4F6;
      --white: #FFFFFF;

      /* radius */
      --r-sm: 8px;
      --r-md: 12px;
      --r-lg: 16px;

      /* shadow */
      --shadow-card: 0 6px 18px rgba(0,0,0,.08);
      --shadow-float: 0 10px 32px rgba(0,0,0,.12);
    }
  </style>

  <!-- =================================================
       BASE / RESET
  ================================================== -->
  <style id="base-style">
    /* reset + body + typography */
  </style>

  <!-- =================================================
       COMPONENT STYLES
  ================================================== -->
  <style id="components-style">
    /* card / button / badge / sheet / input */
  </style>

  <!-- =================================================
       VIEWER v2 STYLES
  ================================================== -->
  <style id="viewer-style">
    /* screen-specific layout */
  </style>
</head>

<body>

  <!-- =================================================
       APP ROOT
  ================================================== -->
  <header id="app-header"></header>
  <main id="app"></main>

  <!-- global backdrop -->
  <div id="backdrop"></div>

  <!-- sheets -->
  <div id="product-sheet" class="sheet"></div>
  <div id="qty-sheet" class="sheet"></div>
  <div id="cart-sheet" class="sheet"></div>
  <div id="login-sheet" class="sheet"></div>

  <!-- =================================================
       SCRIPT
  ================================================== -->
  <script>
    /* ===============================
       GLOBAL STATE (SINGLE SOURCE)
    =============================== */
const STORAGE_KEY = "stockviewer.orders";

function loadOrders() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = JSON.parse(raw);
        if (parsed && parsed.version === 1 && Array.isArray(parsed.orders)) {
      state.orders = parsed.orders;
    }
  } catch (e) {
    console.warn("Failed to load orders", e);
  }
}

function saveOrders() {
  try {
    localStorage.setItem(
      STORAGE_KEY,
      JSON.stringify({
        version: 1,
        orders: state.orders
      })
    );
  } catch (e) {
    console.warn("Failed to save orders", e);
  }
}
    
const state = {
   products: [],
   selectedProduct: null,
   cart: [],
   orders: [],
   selectedOrderId: null,
  batchSelection: {
    shippedOnly: true,
    selectedOrderIds: []
  },

   view: {
     screen: "list", // list | detail | cart | success | admin
     qty: 1
   },

   admin: {
     loggedIn: false,
     user: null,
     token: null
   },

   ui: {
     loading: false,
     overlayCount: 0,
     error: null
   }
 };
  </script>

  <script>
    /* ===============================
       API LAYER
    =============================== */
  </script>

  <script>
    /* ===============================
       UI HELPERS
    =============================== */
function renderHeader() {
   const header = document.getElementById("app-header");

   header.innerHTML = `
     <div class="title">Stock Viewer</div>
     <div class="actions">
       ${
         state.admin.loggedIn
           ? `<span>${state.admin.user}</span>`
           : `<button onclick="openLogin()">üîí ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>`
       }
     </div>
   `;
 }

function openSheet(id) {
   document.getElementById(id)?.classList.add("show");
   state.ui.overlayCount++;
 }

 function closeSheet(id) {
   document.getElementById(id)?.classList.remove("show");
   state.ui.overlayCount = Math.max(0, state.ui.overlayCount - 1);
 }

  </script>

  <script>
    /* ===============================
       SCREEN RENDERERS
    =============================== */
function render() {
   switch (state.view.screen) {
     case "list":
       renderProductList();
       break;
     case "detail":
       renderProductDetail();
       break;
     case "cart":
       renderCart();
       break;
     case "success":
       renderSuccess();
       break;
     case "admin":
       renderAdminOrders();
       break;  
     default:
       console.warn("Unknown screen:", state.view.screen);
   }
 }

function renderProductList() {
  const app = document.getElementById("app");
   
  // loading state
  if (state.ui.loading) {
    app.innerHTML = "<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‚Ä¶</p>";
    return;
  }

  // empty state
  if (!Array.isArray(state.products) || state.products.length === 0) {
    app.innerHTML = "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>";
    return;
  }

  app.innerHTML = `
    <section class="product-list">
      ${state.products.map(renderProductCard).join("")}
    </section>
    ${renderFloatingCart()}
  `;
 }

function renderFloatingCart() {
  if (!Array.isArray(state.cart) || state.cart.length === 0) {
    return "";
  }

  const totalQty = state.cart.reduce(
    (sum, item) => sum + item.qty,
    0
  );

  return `
    <div class="floating-cart" onclick="goToCart()">
      üõí <span class="count">${totalQty}</span>
    </div>
  `;
}
    
function renderProductCard(p) {
  const inCart = state.cart.find(i => i.productId === p.productId);

  return `
    <div class="card" onclick="openProduct('${p.productId}')">
      <div class="name">${p.name}</div>
      <div class="price">${p.price}</div>
      ${
        inCart
          ? `<div class="badge">${inCart.qty}</div>`
          : ""
      }
    </div>
  `;
}

 function renderProductDetail() {
  const app = document.getElementById("app");
  const p = state.selectedProduct;

  // guard: state ‡∏´‡∏•‡∏∏‡∏î
  if (!p) {
    state.view.screen = "list";
    render();
    return;
  }

  app.innerHTML = `
    <section class="product-detail">
      <button class="back" onclick="goToList()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>

      <h2 class="name">${p.name}</h2>
      <div class="price">${p.price}</div>

      ${
        p.description
          ? `<div class="description">${p.description}</div>`
          : ""
      }

      <button class="btn-primary" onclick="openQtyPicker()">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
      </button>
    </section>
  `;
}

 function renderCart() {
   const app = document.getElementById("app");
   
  // empty cart
  if (!Array.isArray(state.cart) || state.cart.length === 0) {
    app.innerHTML = `
      <section class="cart">
        <p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>
        <button onclick="goToList()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </section>
    `;
    return;
  }

  const total = state.cart.reduce(
    (sum, item) => sum + item.price * item.qty,
    0
  );

  app.innerHTML = `
    <section class="cart">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>

      <div class="cart-items">
        ${state.cart.map(renderCartItem).join("")}
      </div>

      <div class="cart-total">
        ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total}
      </div>

      <button class="btn-primary" onclick="submitOrder()">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
      </button>

      <button class="btn-secondary" onclick="goToList()">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
      </button>
    </section>
  `;
}

function renderCartItem(item) {
  return `
    <div class="cart-item">
      <div class="name">${item.name}</div>
      <div class="qty">x${item.qty}</div>
      <div class="price">${item.price * item.qty}</div>
    </div>
  `;
}   

function submitOrder() {
  submitOrderAPI();
}    

 function renderSuccess() {
   const app = document.getElementById("app");
   
  // guard
  if (!state.orders.length) {
    state.view.screen = "list";
    render();
    return;
  }

  const order = state.orders[state.orders.length - 1]; 

  app.innerHTML = `
    <section class="success">
      <h2>‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>

<div class="order-summary">
   ${order.items.map(item => `
     <div class="order-item">
       <span>${item.name} x${item.qty}</span>
       <span>${item.price * item.qty}</span>
     </div>
   `).join("")}
 </div>

      <div class="order-total">
        ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${order.total}
      </div>

      <button class="btn-primary" onclick="goToList()">
        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
      </button>

      <button class="btn-secondary" onclick="viewOrder()">
        ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
      </button>
    </section>
  `;
}

function viewOrder() {
  if (!state.admin.loggedIn) {
    openLogin();
    return;
  }
  state.view.screen = "admin";
  render();
}

function renderAdminOrders() {
  const app = document.getElementById("app");

  // guard: admin only
  if (!state.admin.loggedIn) {
    state.view.screen = "list";
    render();
    return;
  }

  state.selectedOrderId = null;

  if (!state.orders.length) {
    app.innerHTML = "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>";
    return;
  }

  app.innerHTML = `
    <section class="admin-orders">
      <h2>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>

      <label>
    <input type="checkbox"
      ${state.batchSelection.shippedOnly ? "checked" : ""}
      onchange="toggleBatchShippedOnly(this.checked)"
    />
    ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
  </label>

      <div class="order-list">
        ${state.orders
      .filter(o => !o.archived)
      .filter(o => !state.batchSelection.shippedOnly || o.status === "shipped")
   .sort((a, b) => b.createdAt - a.createdAt)
   .map((order, index) => `
          <div class="order-card">
          <input type="checkbox"
            ${state.batchSelection.selectedOrderIds.includes(order.id) ? "checked" : ""}
            onchange="toggleBatchOrder('${order.id}', this.checked)"
          />
          <span onclick="openOrderDetail('${order.id}')">
            <div>Order #${index + 1}</div>
            <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${order.status || "unknown"}</div>
            <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${order.items.length}</div>
            <div>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${order.total}</div>
           </span> 
          </div>
        `).join("")}
      </div>

<h3>üóÉÔ∏è Archived Orders</h3>
      <div class="order-list archived">
        ${state.orders
          .filter(o => o.archived)
          .sort((a, b) => b.createdAt - a.createdAt)
          .map(order => `
            <div class="order-card archived">
              <div>${order.id}</div>
              <div>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${order.total}</div>
              <button onclick="restoreOrder('${order.id}')">‚ôªÔ∏è Restore</button>
            </div>
          `).join("")}
      </div>
<button
  onclick="exportOrdersPDFBatch(state.batchSelection.selectedOrderIds)"
>
  üìÑ Export PDF (Selected)
</button>

      <button onclick="goToList()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button>
    </section>
  `;
}    

function openOrderDetail(orderId) {
  state.selectedOrderId = orderId;
  renderAdminOrderDetail();
}

function renderAdminOrderDetail() {
  const app = document.getElementById("app");
  const order = state.orders.find(o => o.id === state.selectedOrderId);

  if (!order) {
    renderAdminOrders();
    return;
  }

  app.innerHTML = `
    <section class="admin-order-detail">
      <h2>üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
        <div class="readonly-note">üîí Read-only (Admin)</div>

      <div class="order-audit">
       <div><strong>Order ID:</strong> ${order.id}</div>
       <div><strong>Created At:</strong> ${new Date(order.createdAt).toLocaleString()}</div>
     </div>

      ${order.items.map(item => `
        <div class="order-item">
          <span>${item.name} x${item.qty}</span>
          <span>${item.price * item.qty}</span>
        </div>
      `).join("")}

      <div class="order-total">
        ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${order.total}
      </div>

   ${order.status === "new" ? `
   <button onclick="markOrderPaid('${order.id}')">üí∞ Mark as Paid</button>
 ` : ""}

 ${order.status === "paid" ? `
   <button onclick="markOrderShipped('${order.id}')">üöö Mark as Shipped</button>
 ` : ""}

      <div class="order-audit-log">
        <h4>üßæ Audit Trail</h4>
        ${(order.audit || []).map(log => `
          <div class="audit-item">
            <span>${log.action}</span>
            <span>by ${log.by}</span>
            <span>${new Date(log.at).toLocaleString()}</span>
          </div>
        `).join("") || "<p>‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‚Äî</p>"}
      </div>

 <div class="dpi-selector">
   DPI:
<select onchange="setDpiScale(this.value)">
   <option value="1" ${selectedDpiScale === 1 ? "selected" : ""}>1√ó</option>
   <option value="2" ${selectedDpiScale === 2 ? "selected" : ""}>2√ó</option>
   <option value="3" ${selectedDpiScale === 3 ? "selected" : ""}>3√ó</option>
 </select>
</div>

 <button onclick="exportOrderPNG('${order.id}')">üñºÔ∏è Export PNG</button>
 <button onclick="exportOrderPDF('${order.id}')">üìÑ Export PDF (A4)</button>
 <button onclick="printOrder('${order.id}')">üñ®Ô∏è Print</button>

 ${order.status === "shipped" ? `
   <button class="danger" onclick="archiveOrder('${order.id}')">üóëÔ∏è Archive</button>
 ` : `
   <div class="policy-note">‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡∏à‡∏∞ Archive ‡πÑ‡∏î‡πâ</div>
 `}

      <button onclick="renderAdminOrders()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </section>
  `;
}    
  </script>

<script>
  /* ===============================
     AUDIT CONSTANTS (STEP 5B)
  =============================== */
const AUDIT_ACTION = {
  ARCHIVE: "archive",
  RESTORE: "restore",
  MARK_PAID: "mark_paid",
  MARK_SHIPPED: "mark_shipped",
  EXPORT_PDF: "export_pdf",
  EXPORT_PDF_BATCH: "export_pdf_batch"
};
</script>
  
  <script>
    /* ===============================
       EVENT HANDLERS
    =============================== */

const DPI_PRESETS = {
  "1x": 1,
  "2x": 2,
  "3x": 3
};

let selectedDpiScale = 2; // default = 2x

function setDpiScale(value) {
  selectedDpiScale = Number(value) || 2;
}
    
const PNG_A4_PRESET = {
  width: 794,   // A4 @ 96dpi
  height: 1123,
  margin: 48,
  fontFamily: "Arial, sans-serif",
  baseFontSize: 14
};

function buildOrderPNGContainer(order) {
  const c = document.createElement("div");

  c.style.width = PNG_A4_PRESET.width + "px";
  c.style.minHeight = PNG_A4_PRESET.height + "px";
  c.style.padding = PNG_A4_PRESET.margin + "px";
  c.style.boxSizing = "border-box";
  c.style.background = "#fff";
  c.style.color = "#000";
  c.style.fontFamily = PNG_A4_PRESET.fontFamily;
  c.style.fontSize = PNG_A4_PRESET.baseFontSize + "px";
  c.style.lineHeight = "1.6";

  c.innerHTML = `
    <h1 style="margin-bottom:16px">Order ${order.id}</h1>
    <div style="margin-bottom:16px"><strong>Status:</strong> ${order.status}</div>

    <h2>Items</h2>
    ${order.items.map(i => `
      <div style="display:flex;justify-content:space-between">
        <span>${i.name} x${i.qty}</span>
        <span>${i.price * i.qty}</span>
      </div>
    `).join("")}

    <div style="margin-top:16px"><strong>Total:</strong> ${order.total}</div>

    <h2 style="margin-top:24px">Audit Trail</h2>
    ${(order.audit || []).map(a => `
      <div style="font-size:12px;color:#555">
        ${a.action} by ${a.by} @ ${new Date(a.at).toLocaleString()}
      </div>
    `).join("")}
  `;

  return c;
}
    
function exportOrderPNG(orderId) {
  if (!requireAdmin()) return;
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export PNG ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;

  const scale = selectedDpiScale;
  
  const container = buildOrderPNGContainer(order);
  container.style.position = "absolute";
  container.style.left = "-9999px";
  document.body.appendChild(container);

  const contentHeight = container.scrollHeight;
  const pageHeight = PNG_A4_PRESET.height;
  const pageCount = Math.ceil(contentHeight / pageHeight);

 const img = svgToImage(container, PNG_A4_PRESET.width * scale, contentHeight * scale);
 img.onload = () => {
   for (let page = 0; page < pageCount; page++) {
     const canvas = document.createElement("canvas");
     canvas.width = PNG_A4_PRESET.width * scale;
     canvas.height = PNG_A4_PRESET.height * scale;

     canvas.style.width = PNG_A4_PRESET.width + "px";
     canvas.style.height = PNG_A4_PRESET.height + "px";

     const ctx = canvas.getContext("2d");
     ctx.scale(scale, scale);
     ctx.fillStyle = "#fff";
     ctx.fillRect(0, 0, PNG_A4_PRESET.width, PNG_A4_PRESET.height);

     const offsetY = page * pageHeight;
     ctx.save();
     ctx.translate(0, -offsetY);
     ctx.drawImage(
       img,
       0,
       0,
       PNG_A4_PRESET.width,
       contentHeight
     );
     ctx.restore();

     const a = document.createElement("a");
     a.download = `order-${order.id}-${order.status}-dpi${scale}-page-${page + 1}-of-${pageCount}.png`;
     a.href = canvas.toDataURL("image/png");
     a.click();
   }

   alert(`üñºÔ∏è Export ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß\n‚Ä¢ Order: ${order.id}\n‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå: ${pageCount}\n‚Ä¢ DPI: ${scale}√ó`);

   document.body.removeChild(container);
 };
}  
       
function requireAdmin() {
  if (!state.admin.loggedIn) {
    console.warn("Admin permission required");
    return false;
  }
  return true;
}
    
function goToList() {
   state.view.screen = "list";
   render();
 }

 function goToCart() {
   state.view.screen = "cart";
   render();
 }

function openProduct(productId) {
  state.selectedProduct =
    state.products.find(p => p.productId === productId) || null;

  if (!state.selectedProduct) return;

  state.view.screen = "detail";
  render();
}

function openLogin() {
   openSheet("login-sheet");
 }

function increaseQty() {
  state.view.qty++;
  renderQtyPicker();
}

function decreaseQty() {
  if (state.view.qty > 1) {
    state.view.qty--;
    renderQtyPicker();
  }
}

function confirmQty() {
  addToCart();
  closeSheet("qty-sheet");
  render(); // refresh badge / screen
}

function addToCart() {
  const p = state.selectedProduct;
  const qty = state.view.qty;

  if (!p || qty <= 0) return;

  const existing = state.cart.find(
    item => item.productId === p.productId
  );

  if (existing) {
    existing.qty += qty; // merge qty
  } else {
    state.cart.push({
      productId: p.productId,
      name: p.name,
      price: p.price,
      qty
    });
  }
}    

function openQtyPicker() {
  state.view.qty = 1;
  renderQtyPicker();
  openSheet("qty-sheet");
}

function renderQtyPicker() {
  const sheet = document.getElementById("qty-sheet");
  const p = state.selectedProduct;

  // guard: state ‡∏´‡∏•‡∏∏‡∏î
  if (!p) {
    closeSheet("qty-sheet");
    return;
  }

  sheet.innerHTML = `
    <div class="qty-picker">
      <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h3>

      <div class="qty-control">
        <button onclick="decreaseQty()">‚àí</button>
        <span class="qty">${state.view.qty}</span>
        <button onclick="increaseQty()">+</button>
      </div>

      <button class="btn-primary" onclick="confirmQty()">
        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      </button>

      <button class="btn-secondary" onclick="closeSheet('qty-sheet')">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
    </div>
  `;
}

function submitOrderAPI() {
  // guard
  if (!Array.isArray(state.cart) || state.cart.length === 0) return;

  state.ui.loading = true;
  render();

  // mock API
  setTimeout(() => {
    // success
state.orders.push({
      id: `ORD-${Date.now()}`,
      createdAt: Date.now(),
      archived: false,
      audit: [],
      status: "new",
      items: [...state.cart],
      total: state.cart.reduce(
        (sum, item) => sum + item.price * item.qty,
        0
      )
    });

    saveOrders();

    resetAfterOrder();
    state.view.screen = "success";
    state.ui.loading = false;
    render();
  }, 800);
}    

function resetAfterOrder() {
  state.cart = [];
  state.selectedProduct = null;
  state.view.qty = 1;
}

function logAudit(order, action) {
  if (!Array.isArray(order.audit)) {
    order.audit = [];
  }

const last = order.audit[order.audit.length - 1];
  if (last && last.action === action) {
    return; // prevent duplicate consecutive audit
  }
  
  order.audit.push({
    action,
    by: state.admin.user || "unknown",
    at: Date.now()
  });
}
    
function archiveOrder(orderId) {
  if (!requireAdmin()) return;

  const ok = confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Archive ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ?");
  if (!ok) return;
  
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;

  if (order.status !== "shipped") {
    alert("‚ö†Ô∏è ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Archive ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    return;
  }
  
  logAudit(order, AUDIT_ACTION.ARCHIVE);
  order.archived = true;
  saveOrders();
  alert("üì¶ Order ‡∏ñ‡∏π‡∏Å Archive ‡πÅ‡∏•‡πâ‡∏ß");
  renderAdminOrders();
}

function restoreOrder(orderId) {
  if (!requireAdmin()) return;
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;

  logAudit(order, AUDIT_ACTION.RESTORE);
  order.archived = false;
  saveOrders();
  alert("‚ôªÔ∏è Order ‡∏ñ‡∏π‡∏Å Restore ‡πÅ‡∏•‡πâ‡∏ß");
  renderAdminOrders();
} 

function markOrderPaid(orderId) {
  if (!requireAdmin()) return;
  const order = state.orders.find(o => o.id === orderId);
  if (!order || order.status !== "new") return;

  logAudit(order, AUDIT_ACTION.MARK_PAID);
  order.status = "paid";
  saveOrders();
  renderAdminOrderDetail();
}

function markOrderShipped(orderId) {
  if (!requireAdmin()) return;
  const order = state.orders.find(o => o.id === orderId);
  if (!order || order.status !== "paid") return;

  logAudit(order, AUDIT_ACTION.MARK_SHIPPED);
  order.status = "shipped";
  saveOrders();
  renderAdminOrderDetail();
}

function printOrder(orderId) {
  if (!requireAdmin()) return;

  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;

  const win = window.open("", "_blank");
  if (!win) return;

  win.document.write(`
    <html>
    <head>
      <title>Order ${order.id}</title>
      <style>
        body { font-family: sans-serif; padding: 24px; }
        h1, h2 { margin-bottom: 8px; }
        .section { margin-bottom: 16px; }
        .item, .audit { display: flex; justify-content: space-between; }
        .muted { color: #666; font-size: 12px; }
      </style>
    </head>
    <body>
      <h1>Order ${order.id}</h1>

      <div class="section">
       <strong>Status:</strong> ${order.status}
      </div>

      <div class="section">
        <h2>Items</h2>
        ${order.items.map(i => `
          <div class="item">
            <span>${i.name} x${i.qty}</span>
            <span>${i.price * i.qty}</span>
          </div>
        `).join("")}
        <div><strong>Total:</strong> ${order.total}</div>
      </div>

      <div class="section">
        <h2>Audit Trail</h2>
        ${(order.audit || []).map(a => `
          <div class="audit">
            <span>${a.action}</span>
            <span class="muted">${a.by} @ ${new Date(a.at).toLocaleString()}</span>
          </div>
        `).join("")}
      </div>

      <script>
        window.onload = () => window.print();
      <\/script>
    </body>
    </html>
  `);

  win.document.close();
}

function svgToImage(element, width, height) {
  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
     <foreignObject width="100%" height="100%">
      <div xmlns="http://www.w3.org/1999/xhtml">
        ${new XMLSerializer().serializeToString(element)}
      </div>
      </foreignObject>
    </svg>
  `;

  const img = new Image();
  img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  return img;
}

 function exportOrderPDF(orderId) {
   if (!requireAdmin()) return;
   if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export PDF (A4) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

   const order = state.orders.find(o => o.id === orderId);
   if (!order) return;

   if (order.status !== "shipped") {
     alert("‚ö†Ô∏è ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Export PDF ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß");
     return;
   }

   logAudit(order, AUDIT_ACTION.EXPORT_PDF);

   const win = window.open("", "_blank");
   if (!win) return;

   win.document.write(`
     <html>
     <head>
       <title>order-${order.id}.pdf</title>
       <style>
         @page {
           size: A4;
           margin: 24mm;
         }

body {
           font-family: Arial, sans-serif;
           font-size: 12pt;
           color: #000;
           margin: 0;
         }

         /* ===== Print Header / Footer ===== */
         .pdf-header,
         .pdf-footer {
           position: fixed;
           left: 0;
           right: 0;
           color: #555;
           font-size: 10pt;
         }

         .pdf-header {
           top: 0;
           padding: 12mm 24mm 6mm;
           border-bottom: 1px solid #ddd;
         }

         .pdf-footer {
           bottom: 0;
           padding: 6mm 24mm 12mm;
           border-top: 1px solid #ddd;
           display: flex;
           justify-content: space-between;
         }

         .page-number:after {
           content: "Page " counter(page) " / " counter(pages);
         }

         /* content spacing to avoid overlap */
         .pdf-content {
           padding: 32mm 24mm;
         }
         
         .section {
           margin-bottom: 16px;
         }
         .item, .audit {
           display: flex;
           justify-content: space-between;
         }
         .muted {
           color: #666;
           font-size: 10pt;
         }
         
       </style>
     </head>
     <body>
       <div class="pdf-header">
         <strong>Order ${order.id}</strong>
       </div>

       <div class="pdf-footer">
         <div>Printed by: ${state.admin.user || "unknown"}</div>
         <div class="page-number"></div>
       </div>

       <div class="pdf-content">
         <div class="section muted">
           Printed at: ${new Date().toLocaleString()}
         </div>

         <h1>Order ${order.id}</h1>

       <div class="section">
         <strong>Status:</strong> ${order.status}
       </div>

       <div class="section">
         <h2>Items</h2>
         ${order.items.map(i => `
           <div class="item">
             <span>${i.name} x${i.qty}</span>
             <span>${i.price * i.qty}</span>
           </div>
         `).join("")}
         <div><strong>Total:</strong> ${order.total}</div>
       </div>

       <div class="section">
         <h2>Audit Trail</h2>
         ${(order.audit || []).map(a => `
           <div class="audit">
             <span>${a.action}</span>
             <span class="muted">${a.by} @ ${new Date(a.at).toLocaleString()}</span>
           </div>
         `).join("")}
       </div>

       </div> <!-- /.pdf-content -->  
       <script>
         window.onload = () => {
           window.print();
         };
       <\/script>
     </body>
     </html>
   `);

   win.document.close();
 }

function toggleBatchOrder(orderId, checked) {
  const list = state.batchSelection.selectedOrderIds;
  if (checked && !list.includes(orderId)) {
    list.push(orderId);
  }
  if (!checked) {
    state.batchSelection.selectedOrderIds =
      list.filter(id => id !== orderId);
  }
}

function toggleBatchShippedOnly(value) {
  state.batchSelection.shippedOnly = value;
  state.batchSelection.selectedOrderIds = [];
  renderAdminOrders();
}

 function exportOrdersPDFBatch(orderIds) {
  if (!requireAdmin()) return;

  if (!Array.isArray(orderIds) || orderIds.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡πâ Export");
    return;
  }

  const orders = orderIds
    .map(id => state.orders.find(o => o.id === id))
    .filter(Boolean);

  const invalid = orders.filter(o => o.status !== "shipped");
  if (invalid.length > 0) {
    alert("‚ö†Ô∏è ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Export ‡πÑ‡∏î‡πâ");
    return;
  } 

  if (orderIds.length > 10) {
    alert("‚ö†Ô∏è ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£ Export ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
    return;
  }

  const ok = confirm(
    `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export PDF ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${orderIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå)`
  );
  if (!ok) return;

   orders.forEach(o =>
     logAudit(o, AUDIT_ACTION.EXPORT_PDF_BATCH)
   ); 

  let index = 0;

  function next() {
    if (index >= orderIds.length) {
      state.batchSelection.selectedOrderIds = [];
      renderAdminOrders();
      alert("üìÑ Export PDF (Batch) ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå");
      return;
    }

    exportOrderPDF(orderIds[index]);
    index++;

    // delay ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô popup block
    setTimeout(next, 800);
  }

  next();
}

   </script>

  <script>
    /* ===============================
       APP BOOTSTRAP
    =============================== */
function boot() {
   loadOrders();
   renderHeader();
   render();
 }

 boot();
  </script>

</body>
</html>
