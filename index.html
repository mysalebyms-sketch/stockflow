<!DOCTYPE html>
<html lang="th">
<head>
  <!-- =================================================  
       META / CONFIG
  ================================================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Stock Viewer v2</title>

  <!-- üîß Fix favicon 404 -->
  <link rel="icon" href="data:,">

  <!-- =================================================
       TH FONT (Sarabun) ‚Äî Offline / Self-host (STEP 19)
  ================================================== -->
  <link rel="preload" href="assets/fonts/THSarabunNew.ttf"
        as="font" type="font/ttf" crossorigin="anonymous" />
  <link rel="preload" href="assets/fonts/THSarabunNew-Bold.ttf"
        as="font" type="font/ttf" crossorigin="anonymous" />
  
  <style id="font-sarabun">
    @font-face {
      font-family: "Sarabun";
      src: url("assets/fonts/THSarabunNew.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Sarabun";
      src: url("assets/fonts/THSarabunNew-Bold.ttf") format("truetype");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
  </style>
  <!-- =================================================
       DESIGN TOKENS (LOCKED)
  ================================================== -->
  <style id="tokens">
    :root {
      /* colors */
      --primary: #2563EB;
      --success: #16A34A;
      --warning: #F59E0B;
      --danger:  #DC2626;

      --gray-900: #111827;
      --gray-600: #4B5563;
      --gray-400: #9CA3AF;
      --gray-200: #E5E7EB;
      --gray-100: #F3F4F6;
      --white: #FFFFFF;

      /* radius */
      --r-sm: 8px;
      --r-md: 12px;
      --r-lg: 16px;

      /* shadow */
      --shadow-card: 0 6px 18px rgba(0,0,0,.08);
      --shadow-float: 0 10px 32px rgba(0,0,0,.12);
    }
  </style>

  <!-- =================================================
       BASE / RESET
  ================================================== -->
  <style id="base-style">
    /* reset + body + typography */
    body {
      font-family: "Sarabun", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Helvetica Neue", Arial, sans-serif;
      color: var(--gray-900);
      background: var(--white);
      line-height: 1.55;
      font-size: 16px;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>

  <!-- =================================================
       COMPONENT STYLES
  ================================================== -->
  <style id="components-style">
    /* card / button / badge / sheet / input */

 .bar-chart {
   display: grid;
   gap: 8px;
   margin: 12px 0;
 }

 .bar-row {
   display: flex;
   align-items: center;
   gap: 8px;
   font-size: 12px;
 }

 .bar-label {
   width: 120px;
   color: var(--gray-600);
 }

 .bar-track {
   flex: 1;
   background: var(--gray-100);
   border-radius: 6px;
   overflow: hidden;
 }

 .bar-fill {
   height: 10px;
   background: var(--primary);
 }

 .delta {
   font-weight: bold;
 }

 .delta.plus { color: var(--success); }
 .delta.minus { color: var(--danger); }

 .diff-matrix {
   width: 100%;
   border-collapse: collapse;
   margin: 12px 0;
   font-size: 13px;
 }

 .diff-matrix th,
 .diff-matrix td {
   padding: 8px 10px;
   border-bottom: 1px solid var(--gray-200);
   text-align: right;
 }

 .diff-matrix th:first-child,
 .diff-matrix td:first-child {
   text-align: left;
 }

 .diff-matrix thead th {
   color: var(--gray-600);
   font-weight: 600;
   font-size: 12px;
 }
   
 .diff-matrix tr.delta-new {
   background: rgba(22, 163, 74, 0.12); /* success */
 }

 .diff-matrix tr.delta-removed {
   background: rgba(220, 38, 38, 0.12); /* danger */
 }

 .diff-matrix tr.delta-anomaly {
   outline: 2px solid var(--warning);
 }
   
 .diff-matrix tr.delta-new td:first-child::before {
   content: "üÜï ";
 }

 .diff-matrix tr.delta-removed td:first-child::before {
   content: "üóëÔ∏è ";
 }
   
 .diff-matrix .delta {
   display: inline-block;
   min-width: 28px;
   text-align: right;
 }

 .diff-legend {
   display: flex;
   gap: 12px;
   flex-wrap: wrap;
   font-size: 12px;
   color: var(--gray-600);
   margin: 8px 0;
 }

 .diff-legend .legend-item.new { color: var(--success); }
 .diff-legend .legend-item.removed { color: var(--danger); }
 .diff-legend .legend-item.plus { color: var(--success); }
 .diff-legend .legend-item.minus { color: var(--danger); }

 .delta-toggle {
   font-size: 12px;
   color: var(--gray-600);
   margin: 8px 0;
   display: inline-block;
 }

/* STEP 18.4 ‚Äî Alert Severity Badge */
.alert-badge {
  display: inline-block;
  margin-left: 6px;
  padding: 2px 6px;
  border-radius: var(--r-sm);
  font-size: 11px;
  font-weight: 600;
}

.alert-critical {
  background: var(--danger);
  color: var(--white);
}

.alert-warning {
  background: var(--warning);
  color: var(--gray-900);
}

.alert-info {
  background: var(--gray-200);
  color: var(--gray-900);
}

.alert-highlight {
  outline: 2px solid var(--danger);
  background: rgba(220, 38, 38, 0.08);
}

/* STEP 18.10 ‚Äî Visual Priority Highlight */
.alert-highlight--primary {
  outline: 3px solid var(--danger);
  background: rgba(220, 38, 38, 0.12);
}

.alert-highlight--secondary {
  outline: 2px dashed var(--danger);
  background: rgba(220, 38, 38, 0.06);
}

.alert-highlight--tertiary {
  outline: 1px dashed var(--gray-400);
  background: rgba(220, 38, 38, 0.03);
}    

/* STEP 18.11 ‚Äî Alert Priority Legend */
.audit-alert-legend {
  display: flex;
  gap: 8px;
  align-items: center;
  margin: 6px 0 12px;
  font-size: 12px;
}

.audit-action {
  position: sticky;
  top: 0;
  background: var(--white);
  z-index: 2;
  padding: 6px 0;
  cursor: pointer;
}    

.audit-alert-legend span {
  padding: 2px 6px;
  border-radius: var(--r-sm);
}

.audit-item {
  cursor: pointer;
}

.audit-item:hover {
  background: rgba(0,0,0,0.03);
}
    
    
.insight-summary {
  margin: 8px 0 12px;
  font-size: 13px;
}    
  
.muted {
   color: var(--gray-400);
   font-size: 12px;
 }   

/* ===============================
   SHEET + BACKDROP (STEP 18.28)
   - hidden by default
   - show only when .show exists
   =============================== */

body.no-scroll {
  overflow: hidden;
}

#backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.22);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 180ms ease;
  z-index: 999;
}
#backdrop.show {
  opacity: 1;
  pointer-events: auto;
}

.sheet {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  max-height: 85vh;
  overflow: auto;

  background: rgba(255, 255, 255, 0.78);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border-radius: 22px 22px 0 0;
  box-shadow: 0 -12px 30px rgba(0,0,0,0.18);

  transform: translateY(110%);
  opacity: 0;
  pointer-events: none;
  transition:
    transform 220ms cubic-bezier(.2,.8,.2,1),
    opacity 220ms ease;
  z-index: 1000;
}
.sheet.show {
  transform: translateY(0);
  opacity: 1;
  pointer-events: auto;
}

/* optional: spacing for sheet content containers you already use */
.login-sheet,
.qty-picker {
  padding: 16px;
}
 
  </style>

  <!-- =================================================
       VIEWER v2 STYLES
  ================================================== -->
  <style id="viewer-style">
    /* screen-specific layout */
  </style>
</head>

<body>

  <!-- =================================================
       APP ROOT
  ================================================== -->
  <header id="app-header"></header>
  <main id="app"></main>

  <!-- global backdrop -->
  <div id="backdrop"></div>

  <!-- sheets -->
  <div id="product-sheet" class="sheet"></div>
  <div id="qty-sheet" class="sheet"></div>
  <div id="cart-sheet" class="sheet"></div>
  <div id="login-sheet" class="sheet"></div>

  <!-- =================================================
       SCRIPT
  ================================================== -->
  <script>
    /* ===============================
       GLOBAL STATE (SINGLE SOURCE)
    =============================== */
const STORAGE_KEY = "stockviewer.orders";
const AUDIT_FILTER_KEY = "stockviewer.audit.filters";    
const AUDIT_PRESET_KEY = "stockviewer.audit.presets";   
const ANALYTICS_SNAPSHOT_KEY = "stockviewer.analytics.snapshots";  
const ANALYTICS_PREF_KEY = "stockviewer.analytics.prefs";  
const AUDIT_COLLAPSE_KEY = "stockviewer.audit.collapsedActions"; // STEP 18.23
const LAST_SCREEN_KEY = "stockviewer.ui.lastScreen"; // STEP 18.24

// STEP 18.23 ‚Äî Persist collapsedActions (safe + bounded)
const AUDIT_COLLAPSE_TTL_DAYS = 7;
const AUDIT_COLLAPSE_MAX_KEYS = 50;
const LAST_SCREEN_TTL_DAYS = 7; // STEP 18.24    

// STEP 18.24 ‚Äî Persist last open screen (safe + bounded)
// Policy:
// - Restore immediately only for non-admin screens (list/cart)
// - Admin screens stored as pending (requires login persistence to auto-restore later)
function loadLastScreen() {
  try {
    const raw = localStorage.getItem(LAST_SCREEN_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== "object") return;

    const savedAt = Number(parsed.savedAt);
    if (!Number.isFinite(savedAt)) return;
    const ageMs = Date.now() - savedAt;
    const ttlMs = LAST_SCREEN_TTL_DAYS * 24 * 60 * 60 * 1000;
    if (ageMs < 0 || ageMs > ttlMs) return;

    const screen = String(parsed.screen || "");
    const allowed = ["list", "cart", "admin", "audit", "analytics"];
    if (!allowed.includes(screen)) return;

    // restore non-admin screens immediately
    if (screen === "list" || screen === "cart") {
      state.view.screen = screen;
      return;
    }

    // admin screens require auth; keep as pending only
    state.ui.pendingScreen = screen;
    state.ui._skipPersistOnce = true; // STEP 18.24 ‚Äî don't overwrite stored screen on first render
  } catch {}
}

function saveLastScreen() {
  try {
    const screen = String(state.view.screen || "list");
    const allowed = ["list", "cart", "admin", "audit", "analytics"];
    if (!allowed.includes(screen)) return;
    localStorage.setItem(
      LAST_SCREEN_KEY,
      JSON.stringify({
        savedAt: Date.now(),
        screen
      })
    );
  } catch {}
}    

function loadAuditCollapsedActions() {
  try {
    
    const reset = (purge = false) => {
      if (purge) localStorage.removeItem(AUDIT_COLLAPSE_KEY);
      state.audit.collapsedActions = {};
    };
    const raw = localStorage.getItem(AUDIT_COLLAPSE_KEY);
    if (!raw) {
      // storage empty => force default {}
      state.audit.collapsedActions = {};
      return;
    }
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== "object") {
      return reset(true);
    }

    const savedAt = Number(parsed.savedAt);
    if (!Number.isFinite(savedAt)) {
      return reset(true);
    }
    const ageMs = Date.now() - savedAt;
    const ttlMs = AUDIT_COLLAPSE_TTL_DAYS * 24 * 60 * 60 * 1000;
    // guard: clock skew (savedAt in future) => treat as invalid
    if (ageMs < 0) {
      return reset(true);
    }
    if (ageMs > ttlMs) {
      return reset(true);
    }

    const map = parsed.map;
    if (!map || typeof map !== "object") {
      return reset(true);
    }

    // sanitize + cap
    const entries = Object.entries(map)
      .filter(([k, v]) => typeof k === "string" && typeof v === "boolean")
      .slice(0, AUDIT_COLLAPSE_MAX_KEYS);

    state.audit.collapsedActions = Object.fromEntries(entries);
    
  } catch {}
}

function saveAuditCollapsedActions() {
  try {
    
    // STEP 18.23 ‚Äî persist policy:
    // - called only from user-driven toggle (toggleAuditGroup)
    // - MUST NOT be called from alert auto-expand / restore flows
    const map = state.audit.collapsedActions || {};
    const entries = Object.entries(map)
      .filter(([k, v]) => typeof k === "string" && typeof v === "boolean")
      .slice(0, AUDIT_COLLAPSE_MAX_KEYS);

    localStorage.setItem(
      AUDIT_COLLAPSE_KEY,
      JSON.stringify({
        savedAt: Date.now(),
        map: Object.fromEntries(entries)
      })
    );
  } catch {}
}    

function loadOrders() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = JSON.parse(raw);
        if (parsed && parsed.version === 1 && Array.isArray(parsed.orders)) {
      state.orders = parsed.orders;
    }
  } catch (e) {
    console.warn("Failed to load orders", e);
  }
}

function saveOrders() {
  try {
    localStorage.setItem(
      STORAGE_KEY,
      JSON.stringify({
        version: 1,
        orders: state.orders
      })
    );
  } catch (e) {
    console.warn("Failed to save orders", e);
  }
}

 function loadAuditFilter() {
   try {
     const raw = localStorage.getItem(AUDIT_FILTER_KEY);
      if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === "object") {
        // STEP 18.20 ‚Äî persist policy: load only filter fields (collapsedActions is transient)
        if (typeof parsed.filterAction === "string") state.audit.filterAction = parsed.filterAction;
        if (typeof parsed.search === "string") state.audit.search = parsed.search.trim().toLowerCase();
        if (typeof parsed.fromDate === "string") state.audit.fromDate = parsed.fromDate;
        if (typeof parsed.toDate === "string") state.audit.toDate = parsed.toDate;
        if (parsed.lastDays === null || typeof parsed.lastDays === "number") state.audit.lastDays = parsed.lastDays;
      }
    }
   } catch {}
 }

 function saveAuditFilter() {
  // STEP 18.20 ‚Äî persist policy: save only filter fields (collapsedActions is transient)
try {
    localStorage.setItem(
      AUDIT_FILTER_KEY,
      JSON.stringify({
        filterAction: state.audit.filterAction,
        search: (state.audit.search || "").trim().toLowerCase(),
        fromDate: state.audit.fromDate,
        toDate: state.audit.toDate,
        lastDays: state.audit.lastDays
      })
    );
  } catch {}
 }    

 function loadAuditPresets() {
   try {
     return JSON.parse(localStorage.getItem(AUDIT_PRESET_KEY)) || [];
   } catch {
     return [];
   }
 }

 function saveAuditPresets(presets) {
   localStorage.setItem(
     AUDIT_PRESET_KEY,
     JSON.stringify(presets)
   );
 }

 function loadAnalyticsSnapshots() {
   try {
     return JSON.parse(
       localStorage.getItem(ANALYTICS_SNAPSHOT_KEY)
     ) || [];
   } catch {
     return [];
   }
 }

 function saveAnalyticsSnapshot(snapshot) {
   const list = loadAnalyticsSnapshots();
   list.unshift(snapshot); // newest first
   localStorage.setItem(
     ANALYTICS_SNAPSHOT_KEY,
     JSON.stringify(list.slice(0, 10)) // cap 10
   );
 }

 function loadAnalyticsPrefs() {
   try {
     const raw = localStorage.getItem(ANALYTICS_PREF_KEY);
     if (!raw) return;
     const parsed = JSON.parse(raw);
     if (typeof parsed === "object") {
       if (typeof parsed.rangeDays === "number") {
        state.analytics.rangeDays = parsed.rangeDays;
      }
      if (typeof parsed.hideZeroDelta === "boolean") {
        state.analytics.hideZeroDelta = parsed.hideZeroDelta;
      }
      if (typeof parsed.selectedSnapshotIndex === "number") {
        state.analytics.selectedSnapshotIndex = parsed.selectedSnapshotIndex;
      }

     }
   } catch {}
 }

 function saveAnalyticsPrefs() {
   localStorage.setItem(
     ANALYTICS_PREF_KEY,
     JSON.stringify({
       rangeDays: state.analytics.rangeDays,
       hideZeroDelta: state.analytics.hideZeroDelta,
       selectedSnapshotIndex: state.analytics.selectedSnapshotIndex
     })
   );
 }
   
const state = {
   products: [],
   selectedProduct: null,
   cart: [],
   orders: [],
   selectedOrderId: null,
  batchSelection: {
    shippedOnly: true,
    selectedOrderIds: []
  },

   view: {
     screen: "list", // list | detail | cart | success | admin
     qty: 1
   },

   admin: {
     loggedIn: false,
     user: null,
     token: null
   },

   ui: {
     loading: false,
     overlayCount: 0,
     error: null,
     pendingScreen: null,          // STEP 18.24 ‚Äî stored admin destination after login
     pendingAction: null,          // STEP 18.27 ‚Äî one-shot action to resume after login (in-memory)
     pendingActionId: null,        // STEP 18.28 ‚Äî one-shot token to prevent double-run
     _lastPersistedScreen: null,   // STEP 18.24 ‚Äî internal guard (avoid noisy writes)
     _skipPersistOnce: false       // STEP 18.24 ‚Äî prevent boot overwrite when pendingScreen exists
     },
   audit: {
   filterAction: "all",
   search: "",
   fromDate: "",
   toDate: "",
   lastDays: null,
   alertSeverity: null, // STEP 18.21 ‚Äî transient only (must not persist)
   alertTargetActions: [],
   returnScrollTop: null,
   collapsedActions: {}, // STEP 18.18 ‚Äî per action

    // STEP 18.22 ‚Äî one-shot alert mode (transient)
    _fromAlert: false,
    _prevCollapsedActions: null,
    _restoreToken: 0
   },
   analytics: {
   rangeDays: 7,
   selectedSnapshotIndex: 0,
   hideZeroDelta: false,
   snapshotResetNotice: false // STEP 16F
   }
 };
   
  </script>

  <script>
    /* ===============================
       API LAYER
    =============================== */
  </script>

  <script>
    /* ===============================
       UI HELPERS
    =============================== */
function renderHeader() {
   const header = document.getElementById("app-header");

// STEP 18.2 ‚Äî compute alert count (lightweight)
   let alertStats = { critical: 0, warning: 0, info: 0 };
   if (state.admin.loggedIn) {
     const audits = collectAllAudits();
     const trendNow = buildAuditTrendComparison(audits);
     const base = state.analytics.rangeDays === 7
       ? trendNow.last7.byAction
       : trendNow.last30.byAction;
     const rows = buildDiffMatrix(base, {});
     buildTopAlerts(rows).forEach(a => {
     alertStats[a.severity]++;
   });
   }  

   header.innerHTML = `
     <div class="title">Stock Viewer</div>
     <div class="actions">
       ${
         state.admin.loggedIn
          ? `<span>${state.admin.user}</span>
               ${renderAlertBadge(alertStats)}
               <button onclick="handleLogout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>`
             : `<button onclick="openLogin()">üîí ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>`
       }
     </div>
   `;
 }

function renderAlertBadge(stats) {
  if (!stats) return "";

  return `
    ${stats.critical ? `
      <span class="alert-badge alert-critical"
        onclick="openAlertAudit('critical')"
        title="Critical alerts">
        ‚õî ${stats.critical}
      </span>` : ""}
    ${stats.warning ? `
      <span class="alert-badge alert-warning"
        onclick="openAlertAudit('warning')"
        title="Warning alerts">
        ‚ö†Ô∏è ${stats.warning}
      </span>` : ""}
  `;
}

// STEP 18.3 ‚Äî Open Analytics from Alert Badge
function openAlertAnalytics() {
  // STEP 18.26 ‚Äî minimal auth guard UX (remember destination)
  if (!requireAdminScreen("analytics")) return;
  state.view.screen = "analytics";
  state.analytics.alertOnly = true; // transient flag
  render();
}

// STEP 18.5 ‚Äî Open Audit from Alert Badge
function openAlertAudit(severity) {
  // STEP 18.26 ‚Äî minimal auth guard UX (remember destination)
  if (!requireAdminScreen("audit")) return;
  state.view.screen = "audit";
  state.audit.alertSeverity = severity; // transient

  // STEP 18.22 ‚Äî mark one-shot alert navigation + snapshot collapsedActions
  state.audit._fromAlert = true;
  state.audit._prevCollapsedActions = { ...(state.audit.collapsedActions || {}) };
  state.audit._restoreToken++; // start a new restore session id
  
 // STEP 18.7 ‚Äî resolve target action from analytics
 const audits = collectAllAudits();
 const trendNow = buildAuditTrendComparison(audits);
 const base =
   state.analytics.rangeDays === 7
     ? trendNow.last7.byAction
     : trendNow.last30.byAction;
 const rows = buildDiffMatrix(base, {});
 const ranked = buildTopAlerts(rows)
   .filter(a => a.severity === severity)
   .sort((a, b) => {
     // STEP 18.8 ‚Äî priority ranking
     if (b.score !== a.score) return b.score - a.score;        // score ‡∏™‡∏π‡∏á‡∏Å‡πà‡∏≠‡∏ô
     return Math.abs(b.delta) - Math.abs(a.delta);             // impact ‡∏™‡∏π‡∏á‡∏Å‡πà‡∏≠‡∏ô
   });

 const TOP_N = 3;
   state.audit.alertTargetActions =
   ranked.slice(0, TOP_N).map(a => a.key);
  render();
}
    
function syncOverlayUI() {
  const on = (state.ui.overlayCount || 0) > 0;
  document.getElementById("backdrop")?.classList.toggle("show", on);
  document.body.classList.toggle("no-scroll", on);
}

 function openSheet(id) {
   const el = document.getElementById(id);
   if (!el) return;
   // üî¥ CHANGED: ‡∏Å‡∏±‡∏ô overlayCount drift (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥)
   if (!el.classList.contains("show")) {
     el.classList.add("show");
     state.ui.overlayCount = (state.ui.overlayCount || 0) + 1;
     syncOverlayUI(); // üî¥ CHANGED:
   }
  }

 function closeSheet(id) {
   const el = document.getElementById(id);
   if (!el) return;
   // üî¥ CHANGED: ‡∏Å‡∏±‡∏ô overlayCount drift (‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏•‡∏î‡∏ã‡πâ‡∏≥)
   if (el.classList.contains("show")) {
     el.classList.remove("show");
     state.ui.overlayCount = Math.max(0, (state.ui.overlayCount || 0) - 1);
     syncOverlayUI(); // üî¥ CHANGED:
   }
  }

function jumpToAuditRecord(el) {
  if (!el) return;

  el.scrollIntoView({
    behavior: "smooth",
    block: "center"
  });

  el.classList.add("alert-highlight--primary");

  // auto clear highlight
  setTimeout(() => {
    el.classList.remove("alert-highlight--primary");
  }, 1500);
}

function toggleAuditGroup(action) {
if (!action || typeof action !== "string") return;
if (state.audit._fromAlert) {
    state.audit._fromAlert = false;
    state.audit._prevCollapsedActions = null;
    state.audit._restoreToken++; // cancel any queued restore
  }
  state.audit.collapsedActions[action] =
    !state.audit.collapsedActions[action];
  // STEP 18.23 ‚Äî persist only on user-driven toggle (this function)
  saveAuditCollapsedActions();
  render();
}
    
  </script>

  <script>
    /* ===============================
       SCREEN RENDERERS
    =============================== */
function render() {
  // STEP 18.24 ‚Äî persist last screen only when changed
  // Policy: if there is pending admin screen and user not logged in yet, don't overwrite storage.
  if (state.ui._skipPersistOnce) {
    state.ui._skipPersistOnce = false;
    state.ui._lastPersistedScreen = state.view.screen;
  } else if (state.ui._lastPersistedScreen !== state.view.screen) {
    state.ui._lastPersistedScreen = state.view.screen;
    // Only block overwrite when we're on "list" due to unauth guard while pendingScreen exists.
    const shouldBlock =
      state.ui.pendingScreen &&
      !state.admin.loggedIn &&
      state.view.screen === "list";
    if (!shouldBlock) saveLastScreen();
   }

   switch (state.view.screen) {

     case "audit":
       renderAdminAudit();
       break;  
     case "analytics":
       renderAdminAnalytics();
       break;  
     case "list":
       renderProductList();
       break;
     case "detail":
       renderProductDetail();
       break;
     case "cart":
       renderCart();
       break;
     case "success":
       renderSuccess();
       break;
     case "admin":
       renderAdminOrders();
       break;  
     default:
       console.warn("Unknown screen:", state.view.screen);
   }
 }

function renderProductList() {
  const app = document.getElementById("app");
   
  // loading state
  if (state.ui.loading) {
    app.innerHTML = "<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‚Ä¶</p>";
    return;
  }

  // empty state
  if (!Array.isArray(state.products) || state.products.length === 0) {
    app.innerHTML = "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>";
    return;
  }

  app.innerHTML = `
    <section class="product-list">
      ${state.products.map(renderProductCard).join("")}
    </section>
    ${renderFloatingCart()}
  `;
 }

function renderFloatingCart() {
  if (!Array.isArray(state.cart) || state.cart.length === 0) {
    return "";
  }

  const totalQty = state.cart.reduce(
    (sum, item) => sum + item.qty,
    0
  );

  return `
    <div class="floating-cart" onclick="goToCart()">
      üõí <span class="count">${totalQty}</span>
    </div>
  `;
}
    
function renderProductCard(p) {
  const inCart = state.cart.find(i => i.productId === p.productId);

  return `
    <div class="card" onclick="openProduct('${p.productId}')">
      <div class="name">${p.name}</div>
      <div class="price">${p.price}</div>
      ${
        inCart
          ? `<div class="badge">${inCart.qty}</div>`
          : ""
      }
    </div>
  `;
}

 function renderProductDetail() {
  const app = document.getElementById("app");
  const p = state.selectedProduct;

  // guard: state ‡∏´‡∏•‡∏∏‡∏î
  if (!p) {
    state.view.screen = "list";
    render();
    return;
  }

  app.innerHTML = `
    <section class="product-detail">
      <button class="back" onclick="goToList()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>

      <h2 class="name">${p.name}</h2>
      <div class="price">${p.price}</div>

      ${
        p.description
          ? `<div class="description">${p.description}</div>`
          : ""
      }

      <button class="btn-primary" onclick="openQtyPicker()">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
      </button>
    </section>
  `;
}

 function renderCart() {
   const app = document.getElementById("app");
   
  // empty cart
  if (!Array.isArray(state.cart) || state.cart.length === 0) {
    app.innerHTML = `
      <section class="cart">
        <p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>
        <button onclick="goToList()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </section>
    `;
    return;
  }

  const total = state.cart.reduce(
    (sum, item) => sum + item.price * item.qty,
    0
  );

  app.innerHTML = `
    <section class="cart">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>

      <div class="cart-items">
        ${state.cart.map(renderCartItem).join("")}
      </div>

      <div class="cart-total">
        ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total}
      </div>

      <button class="btn-primary" onclick="submitOrder()">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
      </button>

      <button class="btn-secondary" onclick="goToList()">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
      </button>
    </section>
  `;
}

function renderCartItem(item) {
  return `
    <div class="cart-item">
      <div class="name">${item.name}</div>
      <div class="qty">x${item.qty}</div>
      <div class="price">${item.price * item.qty}</div>
    </div>
  `;
}   

function submitOrder() {
  submitOrderAPI();
}    

 function renderSuccess() {
   const app = document.getElementById("app");
   
  // guard
  if (!state.orders.length) {
    state.view.screen = "list";
    render();
    return;
  }

  const order = state.orders[state.orders.length - 1]; 

  app.innerHTML = `
    <section class="success">
      <h2>‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>

<div class="order-summary">
   ${order.items.map(item => `
     <div class="order-item">
       <span>${item.name} x${item.qty}</span>
       <span>${item.price * item.qty}</span>
     </div>
   `).join("")}
 </div>

      <div class="order-total">
        ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${order.total}
      </div>

      <button class="btn-primary" onclick="goToList()">
        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
      </button>

      <button class="btn-secondary" onclick="viewOrder()">
        ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
      </button>
    </section>
  `;
}

function viewOrder() {
  // STEP 18.26 ‚Äî minimal auth guard UX (remember destination)
  if (!requireAdminScreen("admin")) return;
  state.view.screen = "admin";
  render();
}

function openAuditViewer() {
  // STEP 18.26 ‚Äî minimal auth guard UX (remember destination)
  if (!requireAdminScreen("audit")) return;
  // STEP 18.21 ‚Äî clear transient alert context when opening audit normally
  state.audit.alertSeverity = null;
  state.audit.alertTargetActions = [];
  // STEP 18.22 ‚Äî ensure one-shot alert flags are cleared
  state.audit._fromAlert = false;
  state.audit._prevCollapsedActions = null;
  state.audit._restoreToken++;
  state.view.screen = "audit";
  render();
}

function backToAudit() {
  // STEP 18.21 ‚Äî clear transient alert context when returning to audit
  state.audit.alertSeverity = null;
  state.audit.alertTargetActions = [];
  // STEP 18.22 ‚Äî ensure one-shot alert flags are cleared
  state.audit._fromAlert = false;
  state.audit._prevCollapsedActions = null;
  state.audit._restoreToken++;
  state.view.screen = "audit";
  render();

  if (typeof state.audit.returnScrollTop === "number") {
    requestAnimationFrame(() => {
      window.scrollTo({
        top: state.audit.returnScrollTop,
        behavior: "auto"
      });
      state.audit.returnScrollTop = null; // cleanup
    });
  }
}
    
function setAuditFilter(action) {
  state.audit.filterAction = action;
  state.audit.lastDays = null; // STEP 18.20 ‚Äî prevent hidden time constraint
  saveAuditFilter();
  render();
}

function setAuditSearch(value) {
  state.audit.search = value.toLowerCase();
  state.audit.lastDays = null; // STEP 18.20 ‚Äî prevent hidden time constraint
  saveAuditFilter();
  render();
}

function setAuditDateRange(from, to) {
  state.audit.fromDate = from;
  state.audit.toDate = to;
  state.audit.lastDays = null;
  saveAuditFilter();
  render();
}

// STEP 13B ‚Äî Analytics Range Toggle
function setAnalyticsRange(days) {
  state.analytics.rangeDays = days;
  saveAnalyticsPrefs();
  render();
}    

function setAnalyticsSnapshot(index) {
  state.analytics.selectedSnapshotIndex = Number(index) || 0;
  saveAnalyticsPrefs();
  render();
}

 function toggleZeroDelta(value) {
   state.analytics.hideZeroDelta = value;
   saveAnalyticsPrefs();
   render();
 }
    
 function applyAuditPreset(preset) {
   // STEP 18.20 ‚Äî persist policy: apply only filter fields (collapse/transient ignored)
   const f = preset?.filters || {};
   if (typeof f.filterAction === "string") state.audit.filterAction = f.filterAction;
   if (typeof f.search === "string") state.audit.search = f.search.trim().toLowerCase();
   if (typeof f.fromDate === "string") state.audit.fromDate = f.fromDate;
   if (typeof f.toDate === "string") state.audit.toDate = f.toDate;
   if ("lastDays" in f) {
     if (f.lastDays === null || typeof f.lastDays === "number") state.audit.lastDays = f.lastDays;
   } else {
     state.audit.lastDays = null; // STEP 18.20 ‚Äî prevent hidden time constraint when preset doesn't define it
   }
   saveAuditFilter();
   render();
 }

 function applyRelativeDateFilter(audits, days) {
   if (!days) return audits;
   const since = Date.now() - days * 24 * 60 * 60 * 1000;
   return audits.filter(a => a.at >= since);
 }

  function collectAllAudits() {
    return state.orders.flatMap(o =>
      (o.audit || []).map(a => ({
        ...a,
        orderId: o.id
      }))
    );
  }
   
    
 function buildAuditSummary(audits) {
   const byAction = {};
   const byAdmin = {};

   audits.forEach(a => {
     byAction[a.action] = (byAction[a.action] || 0) + 1;
     byAdmin[a.by] = (byAdmin[a.by] || 0) + 1;
   });

   return { byAction, byAdmin };
 }

 function buildAuditTrendComparison(audits) {
   const last7 = applyRelativeDateFilter(audits, 7);
   const last30 = applyRelativeDateFilter(audits, 30);

   return {
     last7: buildAuditSummary(last7),
     last30: buildAuditSummary(last30),
     count7: last7.length,
     count30: last30.length
   };
 }   

function buildDiffMatrix(current = {}, previous = {}) {
  const keys = new Set([
    ...Object.keys(current),
    ...Object.keys(previous)
  ]);

  return Array.from(keys).sort().map(k => {
    const cur = current[k] || 0;
    const prev = previous[k] || 0;
    return {
      key: k,
      current: cur,
      previous: prev,
      delta: cur - prev
    };
  });
}

// STEP 18 ‚Äî Insight Scoring
function scoreDelta(row) {
  const abs = Math.abs(row.delta);

  if (row.previous === 0 && row.current > 0) return 3; // new signal
  if (row.previous > 0 && row.current === 0) return 3; // removed signal

  if (abs >= 10) return 3;
  if (abs >= 5)  return 2;
  if (abs >= 1)  return 1;
  return 0;
}

function detectAnomaly(row) {
  if (row.previous === 0 && row.current > 5) return true;
  if (row.previous > 0 && row.current === 0) return true;
  if (Math.abs(row.delta) >= 10) return true;
  return false;
}

// STEP 18.3 ‚Äî Alert Severity
function getAlertSeverity(score) {
  if (score >= 3) return "critical";
  if (score === 2) return "warning";
  return "info";
}    

// STEP 18.1 ‚Äî Human-readable Insight Summary
function buildInsightSummary(rows = []) {
  if (!rows.length) return "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç";

  const anomalies = rows.filter(detectAnomaly);
  const positives = rows.filter(r => r.delta > 0);
  const negatives = rows.filter(r => r.delta < 0);

  if (anomalies.length > 0) {
    return `‚ö†Ô∏è ‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ${anomalies.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°`;
  }

  if (positives.length && !negatives.length) {
    return `üìà ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (${positives.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
  }

  if (!positives.length && negatives.length) {
    return `üìâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏•‡∏î‡∏•‡∏á (${negatives.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
  }

  return `‚ÑπÔ∏è ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏•‡∏î (‚Üë${positives.length} ‚Üì${negatives.length})`;
}

// STEP 18.2 ‚Äî Build Top Alerts (attention layer)
function buildTopAlerts(rows = []) {
  return rows
    .filter(r => detectAnomaly(r))
    .map(r => ({
      key: r.key,
      delta: r.delta,
      score: scoreDelta(r),
      severity: getAlertSeverity(scoreDelta(r))
    }))
    .filter(a => a.score >= 3);
}   
    
 function renderBarChart(data, max) {
   return `
     <div class="bar-chart">
       ${Object.entries(data).map(([label, value]) => `
         <div class="bar-row">
           <div class="bar-label">${label}</div>
           <div class="bar-track">
             <div class="bar-fill" style="width:${(value / max) * 100}%"></div>
           </div>
           <div>${value}</div>
         </div>
       `).join("")}
     </div>
   `;
 }

 function renderDelta(current, previous) {
   const diff = current - previous;
   if (diff === 0) return `<span class="delta">0</span>`;
   return diff > 0
     ? `<span class="delta plus">+${diff}</span>`
     : `<span class="delta minus">${diff}</span>`;
 }

function renderDiffMatrix(rows) {
  if (!rows.length) return "<p>‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</p>";

  const filtered = state.analytics.hideZeroDelta
    ? rows.filter(r => r.delta !== 0)
    : rows;

  if (!filtered.length) {
    return "<p class='muted'>‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‚Äî</p>";
  }

const sorted = [...filtered].sort(function (a, b) {
  return scoreDelta(b) - scoreDelta(a);
});

  return `
    <table class="diff-matrix">
      <thead>
        <tr>
          <th>Key</th>
          <th>Snapshot</th>
          <th>Current</th>
          <th>Œî</th>
        </tr>
      </thead>
      <tbody>
        ${sorted.map(r => `
          <tr class="${
     detectAnomaly(r) ? 'delta-anomaly' :
      r.previous === 0 && r.current > 0
        ? 'delta-new'
        : r.previous > 0 && r.current === 0
        ? 'delta-removed'
        : ''
    }">
            <td>${r.key}</td>
            <td>${r.previous}</td>
            <td>${r.current}</td>
            <td>${renderDelta(r.current, r.previous)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}
    
function exportAnalyticsJSON() {
  if (!requireAdmin({ type: "export_analytics_json" })) return;

  const audits = collectAllAudits();
  const trend = buildAuditTrendComparison(audits);

  const payload = {
    meta: {
      generatedAt: new Date().toISOString(),
      generatedBy: state.admin.user || "unknown",
      rangeDays: state.analytics.rangeDays
    },
    data: {
      last7: trend.last7,
      last30: trend.last30,
      count7: trend.count7,
      count30: trend.count30
    }
  };

  // STEP 14B ‚Äî save snapshot
  saveAnalyticsSnapshot(payload);

  const blob = new Blob(
    [JSON.stringify(payload, null, 2)],
    { type: "application/json" }
  );

  const a = document.createElement("a");
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = "analytics-snapshot.json";
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}
    
function renderAdminAudit() {
  const app = document.getElementById("app");

  // guard: admin only
  if (!state.admin.loggedIn) {
    state.view.screen = "list";
    render();
    return;
  }

let audits = state.orders
   .flatMap(o => (o.audit || []).map(a => ({
     ...a,
     orderId: o.id
   })));

  audits = applyRelativeDateFilter(
    audits,
    state.audit.lastDays
  );
  
  if (state.audit.filterAction !== "all") {
    audits = audits.filter(a => a.action === state.audit.filterAction);
  }

  if (state.audit.search) {
  audits = audits.filter(a =>
    a.orderId.toLowerCase().includes(state.audit.search) ||
    (a.by || "").toLowerCase().includes(state.audit.search) ||
    a.action.toLowerCase().includes(state.audit.search)
  );
}

if (state.audit.fromDate) {
  const from = new Date(state.audit.fromDate).getTime();
  audits = audits.filter(a => a.at >= from);
}

if (state.audit.toDate) {
  const to = new Date(state.audit.toDate).getTime() + 86400000;
  audits = audits.filter(a => a.at <= to);
}

audits.sort((a, b) => b.at - a.at);  

  // STEP 18.5 ‚Äî filter by alert severity (transient)
 if (state.audit.alertSeverity && state.audit.alertTargetActions?.length) {
   audits = audits.filter(a =>
     state.audit.alertTargetActions.includes(a.action)
   );
 }

// STEP 18.19 ‚Äî auto-expand alert target groups
  if (state.audit._fromAlert) {
    if (state.audit.alertTargetActions?.length) {
      state.audit.alertTargetActions.forEach(action => {
        state.audit.collapsedActions[action] = false;
      });
    } else {
      // STEP 18.22 ‚Äî no targets, close one-shot alert mode immediately
      state.audit._fromAlert = false;
      state.audit._prevCollapsedActions = null;
      state.audit._restoreToken++; // cancel any queued restore
    }
  }
  
  const grouped = audits.reduce((acc, a) => {
    if (!acc[a.action]) acc[a.action] = [];
      acc[a.action].push(a);
    return acc;
  }, {});

  const summary = buildAuditSummary(audits);

  app.innerHTML = `
    <section class="admin-audit">
      <h2>üßæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö</h2>

      <!-- STEP 18.11 ‚Äî Alert Priority Legend -->
  ${state.audit.alertSeverity ? `
    <div class="audit-alert-legend muted">
      <strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong>
      <span class="alert-highlight--primary">Top 1</span>
      <span class="alert-highlight--secondary">Top 2</span>
      <span class="alert-highlight--tertiary">Top 3</span>
    </div>
  ` : ""}

<div class="audit-summary">
   <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
   <div>
     <strong>‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥:</strong>
     ${Object.entries(summary.byAction)
       .map(([k, v]) => `<span>${getActionLabel(k)}: ${v}</span>`)
       .join(" | ")}
   </div>
   <div>
     <strong>‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:</strong>
     ${Object.entries(summary.byAdmin)
       .map(([k, v]) => `<span>${k}: ${v}</span>`)
       .join(" | ")}
   </div>
 </div>      

<div class="audit-tools">
  <input
    type="text"
    placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ / ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• / ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á"
    value="${state.audit.search}"
    oninput="setAuditSearch(this.value)"
  />

  <input
    type="date"
    value="${state.audit.fromDate}"
    onchange="setAuditDateRange(this.value, state.audit.toDate)"
  />

  <input
    type="date"
    value="${state.audit.toDate}"
    onchange="setAuditDateRange(state.audit.fromDate, this.value)"
  />
</div>

<div class="audit-export">
  <button onclick="exportAuditLog('json')">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON</button>
  <button onclick="exportAuditLog('csv')">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
</div>

      <label>
        ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:
        <select onchange="setAuditFilter(this.value)">
          <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          ${Object.values(AUDIT_ACTION).map(a => `
            <option value="${a}" ${state.audit.filterAction === a ? "selected" : ""}>
              ${getActionLabel(a)}
            </option>
          `).join("")}
        </select>
      </label>

      ${Object.keys(grouped).length === 0
        ? "<p>‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ Audit ‚Äî</p>"
      : Object.entries(grouped).map(([action, list]) => `
<h3
   class="audit-action"
   data-action="${action}"
   onclick="toggleAuditGroup('${String(action)
     .replace(/\\/g, '\\\\')
     .replace(/'/g, "\\'")
   }')"
 >
   <span class="audit-toggle">
     ${state.audit.collapsedActions[action] ? "‚ñ∏" : "‚ñæ"}
   </span>
   ${getActionLabel(action)}
 </h3>
${state.audit.collapsedActions[action]
    ? ""
    : list.map(a => `
<div
    class="audit-item"
    data-action="${a.action}"
    data-at="${a.at}"
    onclick="openOrderFromAudit('${a.orderId}', event)"
 >
                <span>Order: ${a.orderId}</span>
                <span>by ${a.by}</span>
                <span>${new Date(a.at).toLocaleString()}</span>
              </div>
            `).join("")}
          `).join("")
      }
      <button onclick="state.view.screen='admin'; render();">‚Üê ‡∏Å‡∏•‡∏±‡∏ö Admin</button>
    </section>
  `;

 // STEP 18.6 ‚Äî scroll & highlight alert target
if (state.audit.alertSeverity && state.audit.alertTargetActions.length) {
   state.audit.alertTargetActions.forEach((action, index) => {
     const header = document.querySelector(
       `.audit-action[data-action="${action}"]`
     );
     if (header) {
       if (index === 0) {
         header.scrollIntoView({ behavior: "smooth", block: "start" });
       }
       const level =
   index === 0
     ? "alert-highlight--primary"
     : index === 1
     ? "alert-highlight--secondary"
     : "alert-highlight--tertiary";

 header.classList.add(level);

       document
         .querySelectorAll(`.audit-item[data-action="${action}"]`)
         .forEach(el => el.classList.add(level));
     }
   });
 }
  
// STEP 18.22 ‚Äî normalize alert mode: restore collapsedActions after one-shot (defer + token)
if (state.audit._fromAlert && state.audit._prevCollapsedActions) {
  const prev = state.audit._prevCollapsedActions;
  state.audit._fromAlert = false;
  state.audit._prevCollapsedActions = null;
  const token = state.audit._restoreToken; // session id created in openAlertAudit
  setTimeout(() => {
    // ignore stale restore
    if (token !== state.audit._restoreToken) return;
   if (prev && typeof prev === "object") {
      // STEP 18.23 ‚Äî sanitize restore payload (boolean map only)
      const entries = Object.entries(prev)
        .filter(([k, v]) => typeof k === "string" && typeof v === "boolean")
        .slice(0, AUDIT_COLLAPSE_MAX_KEYS);
      state.audit.collapsedActions = Object.fromEntries(entries);
      // refresh UI only if still in audit
      if (state.view.screen === "audit") {
        const y = window.scrollY;
        render();
        requestAnimationFrame(() => {
          window.scrollTo({ top: y, behavior: "auto" });
        });
      }
    }
  }, 1500);
}

  state.audit.alertTargetActions = [];
  state.audit.alertSeverity = null;

 }   

 function renderAdminAnalytics() {
  const app = document.getElementById("app");

  if (!state.admin.loggedIn) {
    state.view.screen = "list";
    render();
    return;
  }

  const snapshots = loadAnalyticsSnapshots();

  // STEP 16E ‚Äî clamp selectedSnapshotIndex
  if (snapshots.length === 0) {
    if (state.analytics.selectedSnapshotIndex !== 0) {
      state.analytics.selectedSnapshotIndex = 0;
      state.analytics.snapshotResetNotice = true;
      saveAnalyticsPrefs();
    }
  } else if (
    state.analytics.selectedSnapshotIndex < 0 ||
    state.analytics.selectedSnapshotIndex >= snapshots.length
  ) {
    state.analytics.selectedSnapshotIndex = 0;
    state.analytics.snapshotResetNotice = true;
    saveAnalyticsPrefs();
  }

  const selected =
    snapshots[state.analytics.selectedSnapshotIndex] || null;
  const lastSnapshot = snapshots[0];

  const auditsNow = collectAllAudits();
  const trendNow = buildAuditTrendComparison(auditsNow); 
  const trendSnapshot = selected
  ? selected.data
  : null;
  const alertOnly = state.analytics.alertOnly; 
  const range = state.analytics.rangeDays;
  const snapshotRangeMismatch =
   trendSnapshot &&
   selected.meta.rangeDays !== range; 
  const base =
  trendSnapshot
    ? (range === 7
        ? trendSnapshot.last7
        : trendSnapshot.last30)
    : (range === 7
        ? trendNow.last7
        : trendNow.last30);

  app.innerHTML = `
    <section class="admin-analytics">
      <h2>üìà Audit Insights</h2>

     ${state.analytics.snapshotResetNotice ? `
     <p class="muted">
       ‚ö†Ô∏è Snapshot ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
       ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Snapshot ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
     </p>
     ` : ""}

     ${snapshotRangeMismatch ? `
     <p class="muted">
       ‚ö†Ô∏è Snapshot ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${selected.meta.rangeDays} ‡∏ß‡∏±‡∏ô
     </p>
     ` : ""}

      ${lastSnapshot ? `
        <div class="analytics-snapshot">
          <small>
            üì¶ Last saved:
            ${new Date(lastSnapshot.meta.generatedAt).toLocaleString()}
            (${lastSnapshot.meta.rangeDays} days)
          </small>
        </div>
      ` : ""}

      <div class="analytics-export">
        <button onclick="exportAnalyticsPNG()">üñºÔ∏è Export PNG</button>
        <button onclick="exportAnalyticsJSON()">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON</button>
      </div>

      ${snapshots.length > 0 ? `
  <div class="analytics-snapshot-select">
    <label>
      üì¶ Snapshot:
      <select onchange="setAnalyticsSnapshot(this.value)">
        ${snapshots.map((s, i) => `
          <option value="${i}"
            ${i === state.analytics.selectedSnapshotIndex ? "selected" : ""}>
            ${new Date(s.meta.generatedAt).toLocaleString()}
            (${s.meta.rangeDays}d)
          </option>
        `).join("")}
      </select>
    </label>
  </div>
` : ""}

      <div class="analytics-toggle">
    <button
      onclick="setAnalyticsRange(7)"
      ${state.analytics.rangeDays === 7 ? "disabled" : ""}
    >7 Days</button>
    <button
      onclick="setAnalyticsRange(30)"
      ${state.analytics.rangeDays === 30 ? "disabled" : ""}
    >30 Days</button>
  </div>

      <h3>Trend Compare</h3>
      ${trendSnapshot ? `
  <p>Snapshot 7 days: ${trendSnapshot.count7}</p>
  <p>Snapshot 30 days: ${trendSnapshot.count30}</p>
` : ""}

<h3>Top Actions (Last ${range} days)</h3>
 ${trendSnapshot ? `
     <div class="insight-summary muted">
       ${buildInsightSummary(
         buildDiffMatrix(
           range === 7
             ? trendSnapshot.last7.byAction
             : trendSnapshot.last30.byAction,
           range === 7
             ? trendNow.last7.byAction
             : trendNow.last30.byAction
         )
       )}
     </div>
    ` : ""}
     
  <h4>Œî by Action (Snapshot ‚Üí Current)</h4>

 <label class="delta-toggle">
   <input type="checkbox"
     ${state.analytics.hideZeroDelta ? "checked" : ""}
     onchange="toggleZeroDelta(this.checked)"
   />
   ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Œî = 0
 </label>

 <div class="diff-legend">
   <span class="legend-item new">üÜï New (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0)</span>
   <span class="legend-item removed">üóëÔ∏è Removed (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 0)</span>
   <span class="legend-item plus">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô</span>
   <span class="legend-item minus">‚àí ‡∏•‡∏î‡∏•‡∏á</span>
 </div>

${
   trendSnapshot
     ? renderDiffMatrix(
         (() => {
           const rows = buildDiffMatrix(
             range === 7 ? trendSnapshot.last7.byAction : trendSnapshot.last30.byAction,
             range === 7 ? trendNow.last7.byAction : trendNow.last30.byAction
           );
           return alertOnly
             ? rows.filter(r => detectAnomaly(r) && scoreDelta(r) >= 3)
             : rows;
         })()
       )
     : ""
 }

 <p>
   Œî vs 30 days:
   ${range === 7
    ? renderDelta(trendNow.count7, trendNow.count30)
    : renderDelta(trendNow.count30, trendNow.count7)
  }
 </p>

 ${trendSnapshot ? `
   <h3>Œî Snapshot ‚Üí Current</h3>
   <p>
     7 days:
     ${renderDelta(trendNow.count7, trendSnapshot.count7)}
   </p>
   <p>
     30 days:
     ${renderDelta(trendNow.count30, trendSnapshot.count30)}
   </p>
 ` : ""}
 
${trendSnapshot ? `
  <h3>Œî by Admin (Last 7 days)</h3>
${renderDiffMatrix(
   buildDiffMatrix(
    range === 7 ? trendSnapshot.last7.byAdmin : trendSnapshot.last30.byAdmin,
    range === 7 ? trendNow.last7.byAdmin : trendNow.last30.byAdmin
  )
 )}
` : ""}

      <button onclick="openAuditViewer()">‚Üê Back to Audit</button>
    </section>
  `;

   // STEP 16F ‚Äî clear one-time notice
  state.analytics.snapshotResetNotice = false;
  state.analytics.alertOnly = false;
 }
    
function renderAdminOrders() {
  const app = document.getElementById("app");

  // guard: admin only
  if (!state.admin.loggedIn) {
    state.view.screen = "list";
    render();
    return;
  }

  state.selectedOrderId = null;

  if (!state.orders.length) {
    app.innerHTML = "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>";
    return;
  }

  app.innerHTML = `
    <section class="admin-orders">
      <h2>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>

      <label>
    <input type="checkbox"
      ${state.batchSelection.shippedOnly ? "checked" : ""}
      onchange="toggleBatchShippedOnly(this.checked)"
    />
    ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
  </label>

      <div class="order-list">
        ${state.orders
      .filter(o => !o.archived)
      .filter(o => !state.batchSelection.shippedOnly || o.status === "shipped")
   .sort((a, b) => b.createdAt - a.createdAt)
   .map((order, index) => `
          <div class="order-card">
          <input type="checkbox"
            ${state.batchSelection.selectedOrderIds.includes(order.id) ? "checked" : ""}
            onchange="toggleBatchOrder('${order.id}', this.checked)"
          />
          <span onclick="openOrderDetail('${order.id}')">
            <div>Order #${index + 1}</div>
            <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${order.status || "unknown"}</div>
            <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${order.items.length}</div>
            <div>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${order.total}</div>
           </span> 
          </div>
        `).join("")}
      </div>

<h3>üóÉÔ∏è Archived Orders</h3>
      <div class="order-list archived">
        ${state.orders
          .filter(o => o.archived)
          .sort((a, b) => b.createdAt - a.createdAt)
          .map(order => `
            <div class="order-card archived">
              <div>${order.id}</div>
              <div>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${order.total}</div>
              <button onclick="restoreOrder('${order.id}')">‚ôªÔ∏è Restore</button>
            </div>
          `).join("")}
      </div>
<button
  onclick="exportOrdersPDFBatch(state.batchSelection.selectedOrderIds)"
>
  üìÑ Export PDF (Selected)
</button>

      <button onclick="goToList()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button>
      <button onclick="openAuditViewer()">üßæ Audit Viewer</button>
    </section>
  `;
}    

function openOrderDetail(orderId) {
  state.selectedOrderId = orderId;
  renderAdminOrderDetail();
}

function openOrderFromAudit(orderId, evt) {
if (!orderId) return;

  // STEP 18.15 ‚Äî preserve audit scroll
  state.audit.returnScrollTop = window.scrollY;
  state.selectedOrderId = orderId;
  state.audit.jumpTo = {
    action: evt?.currentTarget?.dataset?.action,
    at: evt?.currentTarget?.dataset?.at
  }; // transient
  renderAdminOrderDetail();
}    

function renderAdminOrderDetail() {
  const app = document.getElementById("app");
  const order = state.orders.find(o => o.id === state.selectedOrderId);

  if (!order) {
    state.view.screen = "admin";
    render();
    return;
  }

  app.innerHTML = `
    <section class="admin-order-detail">
      <h2>üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
        <div class="readonly-note">üîí Read-only (Admin)</div>

      <div class="order-audit">
       <div><strong>Order ID:</strong> ${order.id}</div>
       <div><strong>Created At:</strong> ${new Date(order.createdAt).toLocaleString()}</div>
     </div>

      ${order.items.map(item => `
        <div class="order-item">
          <span>${item.name} x${item.qty}</span>
          <span>${item.price * item.qty}</span>
        </div>
      `).join("")}

      <div class="order-total">
        ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${order.total}
      </div>

   ${order.status === "new" ? `
   <button onclick="markOrderPaid('${order.id}')">üí∞ Mark as Paid</button>
 ` : ""}

 ${order.status === "paid" ? `
   <button onclick="markOrderShipped('${order.id}')">üöö Mark as Shipped</button>
 ` : ""}

      <div class="order-audit-log">
        <h4>üßæ Audit Trail</h4>
 ${(order.audit || []).map(log => `
   <div
     class="audit-item"
     data-action="${log.action}"
     data-at="${log.at}"
   >
            <span>${log.action}</span>
            <span>by ${log.by}</span>
            <span>${new Date(log.at).toLocaleString()}</span>
          </div>
        `).join("") || "<p>‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‚Äî</p>"}
      </div>

 <div class="dpi-selector">
   DPI:
<select onchange="setDpiScale(this.value)">
   <option value="1" ${selectedDpiScale === 1 ? "selected" : ""}>1√ó</option>
   <option value="2" ${selectedDpiScale === 2 ? "selected" : ""}>2√ó</option>
   <option value="3" ${selectedDpiScale === 3 ? "selected" : ""}>3√ó</option>
 </select>
</div>

 <button onclick="exportOrderPNG('${order.id}')">üñºÔ∏è Export PNG</button>
 <button onclick="exportOrderPDF('${order.id}')">üìÑ Export PDF (A4)</button>
 <button onclick="printOrder('${order.id}')">üñ®Ô∏è Print</button>

 ${order.status === "shipped" ? `
   <button class="danger" onclick="archiveOrder('${order.id}')">üóëÔ∏è Archive</button>
 ` : `
   <div class="policy-note">‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡∏à‡∏∞ Archive ‡πÑ‡∏î‡πâ</div>
 `}

      <button onclick="backToAudit()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö Audit</button>
    </section>
  `;
  // STEP 18.14 ‚Äî auto-scroll + highlight audit record
  if (state.audit.jumpTo) {
   const el = document.querySelector(
      `.order-audit-log .audit-item[data-action="${state.audit.jumpTo.action}"][data-at="${state.audit.jumpTo.at}"]`
   );
    if (el) {
      el.scrollIntoView({ behavior: "smooth", block: "center" });
      el.classList.add("alert-highlight--primary");
      setTimeout(() => {
        el.classList.remove("alert-highlight--primary");
      }, 1500);
    }
    state.audit.jumpTo = null; // cleanup
  }
}    
  </script>

<script>
  /* ===============================
     AUDIT CONSTANTS (STEP 5B)
  =============================== */
const AUDIT_ACTION = {
  ARCHIVE: "archive",
  RESTORE: "restore",
  MARK_PAID: "mark_paid",
  MARK_SHIPPED: "mark_shipped",
  EXPORT_PDF: "export_pdf",
  EXPORT_PDF_BATCH: "export_pdf_batch"
};

function getActionLabel(action) {
  const map = {
    archive: "‡πÄ‡∏Å‡πá‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£",
    restore: "‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô",
    mark_paid: "‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß",
    mark_shipped: "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß",
    export_pdf: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF",
    export_pdf_batch: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)"
  };
  return map[action] || action;
}  
</script>

<!-- PNG Export Engine (production-grade) -->
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>  
  
  <script>
    /* ===============================
       EVENT HANDLERS
    =============================== */

const DPI_PRESETS = {
  "1x": 1,
  "2x": 2,
  "3x": 3
};

let selectedDpiScale = 2; // default = 2x

function setDpiScale(value) {
  selectedDpiScale = Number(value) || 2;
}
    
const PNG_A4_PRESET = {
  width: 794,   // A4 @ 96dpi
  height: 1123,
  margin: 48,
  fontFamily: '"Sarabun", Arial, sans-serif',
  baseFontSize: 14
};

 function getExportMeta() {
   return {
     generatedBy: state.admin.user || "unknown",
     generatedAt: new Date().toISOString()
   };
 }
    
function buildOrderPNGContainer(order) {
  const c = document.createElement("div");

  c.style.width = PNG_A4_PRESET.width + "px";
  c.style.minHeight = PNG_A4_PRESET.height + "px";
  c.style.padding = PNG_A4_PRESET.margin + "px";
  c.style.boxSizing = "border-box";
  c.style.background = "#fff";
  c.style.color = "#000";
  c.style.fontFamily = PNG_A4_PRESET.fontFamily;
  c.style.fontSize = PNG_A4_PRESET.baseFontSize + "px";
  c.style.lineHeight = "1.6";

  c.innerHTML = `
    <h1 style="margin-bottom:16px">Order ${order.id}</h1>
    <div style="margin-bottom:16px"><strong>Status:</strong> ${order.status}</div>

    <h2>Items</h2>
    ${order.items.map(i => `
      <div style="display:flex;justify-content:space-between">
        <span>${i.name} x${i.qty}</span>
        <span>${i.price * i.qty}</span>
      </div>
    `).join("")}

    <div style="margin-top:16px"><strong>Total:</strong> ${order.total}</div>

    <h2 style="margin-top:24px">Audit Trail</h2>
    ${(order.audit || []).map(a => `
      <div style="font-size:12px;color:#555">
        ${a.action} by ${a.by} @ ${new Date(a.at).toLocaleString()}
      </div>
    `).join("")}
  `;

  return c;
}
    
function exportOrderPNG(orderId) {
  if (!requireAdmin({ type: "export_order_png", orderId })) return;
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export PNG ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;

  const scale = selectedDpiScale;
  
  const container = buildOrderPNGContainer(order);
  container.style.position = "absolute";
  container.style.left = "-9999px";
  document.body.appendChild(container);

  (async () => {
    try {
      // ensure webfont loaded before capture (Thai text won't fallback)
      if (document.fonts && document.fonts.ready) {
        await document.fonts.ready;
      }
      // capture full container as a big canvas
      const fullCanvas = await captureElementCanvas(container, {
        scale,
        backgroundColor: "#fff",
        ignoreScroll: true
      });

      const contentHeight = fullCanvas.height / scale; // back to CSS px
      const pageHeight = PNG_A4_PRESET.height;
      const pageCount = Math.ceil(contentHeight / pageHeight);

      for (let page = 0; page < pageCount; page++) {
        const pageCanvas = document.createElement("canvas");
        pageCanvas.width = PNG_A4_PRESET.width * scale;
        pageCanvas.height = PNG_A4_PRESET.height * scale;

        const ctx = pageCanvas.getContext("2d");
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);

        const srcY = page * pageHeight * scale;
        const srcH = PNG_A4_PRESET.height * scale;

        // draw slice from fullCanvas
        ctx.drawImage(
          fullCanvas,
          0, srcY,                         // sx, sy
          PNG_A4_PRESET.width * scale, srcH,// sw, sh
          0, 0,                             // dx, dy
          PNG_A4_PRESET.width * scale, srcH // dw, dh
        );

        await downloadCanvasPNG(
          pageCanvas,
          `order-${order.id}-${order.status}-dpi${scale}-page-${page + 1}-of-${pageCount}.png`
        );
      }

      alert(`üñºÔ∏è Export ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß\n‚Ä¢ Order: ${order.id}\n‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå: ${pageCount}\n‚Ä¢ DPI: ${scale}√ó`);
    } catch (e) {
      console.warn("exportOrderPNG failed", e);
      alert("‚ùå Export PNG ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (html2canvas)");
    } finally {
      document.body.removeChild(container);
    }
  })();
}  
       
function requireAdmin(pendingAction) {
   if (!state.admin.loggedIn) {
     console.warn("Admin permission required");
     // STEP 18.26 ‚Äî align UX with screen-guard: prompt login on protected actions too
     // NOTE: do NOT set pendingScreen here (this is an action guard, not screen navigation)
    if (pendingAction && typeof pendingAction === "object") {
      // STEP 18.28 ‚Äî store one-shot action safely (in-memory only)
      // - attach id for double-run guard
      // - clone minimal payload to avoid mutation
      const id = String(pendingAction.id || `${Date.now()}-${Math.random().toString(16).slice(2)}`);
      state.ui.pendingActionId = id;
      if (Array.isArray(pendingAction.orderIds)) {
        state.ui.pendingAction = {
          ...pendingAction,
          id,
          orderIds: pendingAction.orderIds.slice(0, 10).map(String)
        };
      } else {
        state.ui.pendingAction = { ...pendingAction, id };
      }
   }
    openLogin();
    return false;
  }
  return true;
}

// STEP 18.25 ‚Äî Consume pendingScreen after Login (Auto-Return UX)
function consumePendingScreenAfterLogin() {
  const target = state?.ui?.pendingScreen;
  if (!target) return;

  // allow only admin destinations
  const allowed = ["admin", "audit", "analytics"];
  if (!allowed.includes(target)) {
    state.ui.pendingScreen = null;
    return;
  }

  // consume + navigate
  state.ui.pendingScreen = null;
  state.view.screen = target;

  // ensure persistence updates to the new screen
  state.ui._lastPersistedScreen = null; // force render() to consider save
  saveLastScreen();
}    

// STEP 18.27 ‚Äî Consume pendingAction after Login (one-shot)
function consumePendingActionAfterLogin() {
  const a = state?.ui?.pendingAction;
  if (!a) return false;

  // STEP 18.28 ‚Äî double-run guard (id-based)
  const id = String(a.id || "");
  if (id && state.ui.pendingActionId && id !== state.ui.pendingActionId) {
    // stale / overwritten action
    state.ui.pendingAction = null;
    state.ui.pendingActionId = null;
    return false;
  }

  // consume first (prevent loops)
  state.ui.pendingAction = null;
  state.ui.pendingActionId = null;

  // STEP 18.28 ‚Äî validate + sanitize payload
  const type = String(a.type || "");
  const orderId = typeof a.orderId === "string" ? a.orderId : (a.orderId != null ? String(a.orderId) : "");
  const format = String(a.format || "json").toLowerCase();
  const orderIds = Array.isArray(a.orderIds)
    ? a.orderIds.map(String).filter(Boolean).slice(0, 10)
    : [];

  const allowedTypes = new Set([
    "export_order_png",
    "export_order_pdf",
    "print_order",
    "export_audit",
    "export_analytics_png",
    "export_analytics_json",
    "export_orders_pdf_batch",
    "archive_order",
    "restore_order",
    "mark_paid",
    "mark_shipped"
  ]);
  if (!allowedTypes.has(type)) return false;

  try {
    // STEP 18.28 ‚Äî defer execution to avoid immediate confirm right after login
    const run = () => {
      switch (type) {
      case "export_order_png":
        if (!orderId) return false;
        exportOrderPNG(orderId);
        return true;
      case "export_order_pdf":
        if (!orderId) return false;
        // STEP 18.29 ‚Äî already confirmed in popupTypes guard, avoid double-confirm
        exportOrderPDF(orderId, { skipConfirm: true });
        return true;
      case "print_order":
        if (!orderId) return false;
        printOrder(orderId);
        return true;
      case "export_audit":
        if (format !== "json" && format !== "csv") return false;
        exportAuditLog(format);
        return true;
      case "export_analytics_png":
        // Ensure the analytics screen DOM exists before exporting
        if (state.view.screen !== "analytics") {
          state.view.screen = "analytics";
          render();
        }
        // Let layout settle one frame
        requestAnimationFrame(() => exportAnalyticsPNG());
        return true;
      case "export_analytics_json":
        exportAnalyticsJSON();
        return true;
      case "export_orders_pdf_batch":
        exportOrdersPDFBatch(orderIds, { skipConfirm: true });
        return true;
      case "archive_order":
        if (!orderId) return false;
        archiveOrder(orderId);
        return true;
      case "restore_order":
        if (!orderId) return false;
        restoreOrder(orderId);
        return true;
      case "mark_paid":
        if (!orderId) return false;
        markOrderPaid(orderId);
        return true;
      case "mark_shipped":
        if (!orderId) return false;
        markOrderShipped(orderId);
        return true;
      default:
        return false;
     }
    };

// STEP 18.29 ‚Äî popup-sensitive actions must run under user gesture
    const popupTypes = new Set([
      "print_order",
      "export_order_pdf",
      "export_orders_pdf_batch"
    ]);
    if (popupTypes.has(type)) {
      const ok = confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)");
      if (!ok) return false;
      return !!run();
    }

    // non-popup actions: defer to let sheet close + layout settle
    setTimeout(run, 80);
    return true;
  } catch (e) {
    console.warn("Failed to resume pending action", e);
    return false;
  }
}
    
function goToList() {
   state.view.screen = "list";
   render();
 }

 function goToCart() {
   state.view.screen = "cart";
   render();
 }

function openProduct(productId) {
  state.selectedProduct =
    state.products.find(p => p.productId === productId) || null;

  if (!state.selectedProduct) return;

  state.view.screen = "detail";
  render();
}

function openLogin() {
  // STEP 18.26 ‚Äî ensure login sheet is wired before showing
  renderLoginSheet();
  // guard: avoid overlayCount drifting if login sheet is already open
  const el = document.getElementById("login-sheet");
  if (!el?.classList.contains("show")) {
    openSheet("login-sheet");
  }
  // focus first input for better UX
  requestAnimationFrame(() => {
    document.getElementById("login-user")?.focus();
  });
}

// STEP 18.25 ‚Äî Basic Login Success Handler
function handleLoginSuccess(user) {
  state.admin.loggedIn = true;
  state.admin.user = user || "admin";

  closeSheet("login-sheet");

  // STEP 18.27 ‚Äî resume pending action first (one-shot)
  const didResumeAction = consumePendingActionAfterLogin();

  // STEP 18.28 ‚Äî ensure pendingScreen happens after (and not before) action scheduling
  // If an action was resumed, we still allow pendingScreen to restore, but defer it after action tick.
  if (state.ui.pendingScreen) {
    setTimeout(() => {
      // only restore if still logged in and screen still pending
      if (!state.admin.loggedIn) return;
      consumePendingScreenAfterLogin();
      renderHeader();
      render();
    }, didResumeAction ? 1 : 0);
  }

  renderHeader();
  render();
}    

// STEP 18.26 ‚Äî Login Sheet Wiring (submit/enter)
function renderLoginSheet() {
  const sheet = document.getElementById("login-sheet");
  if (!sheet) return;

  sheet.innerHTML = `
    <div class="login-sheet">
      <h3>üîí Admin Login</h3>
      <form onsubmit="submitLogin(event)">
        <label class="muted">Username</label>
        <input id="login-user" type="text" autocomplete="username" />

        <label class="muted" style="margin-top:8px;display:block;">Password</label>
        <input id="login-pass" type="password" autocomplete="current-password" />

        <div style="display:flex;gap:8px;margin-top:12px;">
          <button class="btn-primary" type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          <button class="btn-secondary" type="button" onclick="cancelLogin()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
        <div class="muted" style="margin-top:10px;">
          * ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (demo)
        </div>
      </form>
    </div>
  `;
}

// STEP 18.26 ‚Äî Cancel login safely (avoid pendingScreen stuck)
function cancelLogin() {
  // user explicitly cancels auth ‚Üí clear pending destination
  state.ui.pendingScreen = null;
  state.ui.pendingAction = null; // STEP 18.27
  state.ui.pendingActionId = null; // STEP 18.28 ‚Äî clear stale token
  closeSheet("login-sheet");
}
    
// STEP 18.26 ‚Äî Login submit handler
function submitLogin(evt) {
  evt?.preventDefault?.();
  const user = (document.getElementById("login-user")?.value || "").trim();
  // NOTE: demo auth (no real validation)
  handleLoginSuccess(user || "admin");
}

// STEP 18.26 ‚Äî Minimal Auth Guard UX (remember destination then login)
function requireAdminScreen(target) {
  if (state.admin.loggedIn) return true;
  const allowed = ["admin", "audit", "analytics"];
  if (allowed.includes(target)) {
    state.ui.pendingScreen = target;
  }
  openLogin();
  return false;
}

// STEP 18.26 ‚Äî Logout (minimal)
function handleLogout() {
  const ok = confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
  if (!ok) return;
  state.admin.loggedIn = false;
  state.admin.user = null;
  state.admin.token = null;
  state.ui.pendingScreen = null;
  state.ui.pendingAction = null; // STEP 18.27
  state.ui.pendingActionId = null; // STEP 18.28 ‚Äî clear stale token
  state.view.screen = "list";
  renderHeader();
  render();
}    

function increaseQty() {
  state.view.qty++;
  renderQtyPicker();
}

function decreaseQty() {
  if (state.view.qty > 1) {
    state.view.qty--;
    renderQtyPicker();
  }
}

function confirmQty() {
  addToCart();
  closeSheet("qty-sheet");
  render(); // refresh badge / screen
}

function addToCart() {
  const p = state.selectedProduct;
  const qty = state.view.qty;

  if (!p || qty <= 0) return;

  const existing = state.cart.find(
    item => item.productId === p.productId
  );

  if (existing) {
    existing.qty += qty; // merge qty
  } else {
    state.cart.push({
      productId: p.productId,
      name: p.name,
      price: p.price,
      qty
    });
  }
}    

function openQtyPicker() {
  state.view.qty = 1;
  renderQtyPicker();
  openSheet("qty-sheet");
}

function renderQtyPicker() {
  const sheet = document.getElementById("qty-sheet");
  const p = state.selectedProduct;

  // guard: state ‡∏´‡∏•‡∏∏‡∏î
  if (!p) {
    closeSheet("qty-sheet");
    return;
  }

  sheet.innerHTML = `
    <div class="qty-picker">
      <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h3>

      <div class="qty-control">
        <button onclick="decreaseQty()">‚àí</button>
        <span class="qty">${state.view.qty}</span>
        <button onclick="increaseQty()">+</button>
      </div>

      <button class="btn-primary" onclick="confirmQty()">
        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      </button>

      <button class="btn-secondary" onclick="closeSheet('qty-sheet')">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
    </div>
  `;
}

function submitOrderAPI() {
  // guard
  if (!Array.isArray(state.cart) || state.cart.length === 0) return;

  state.ui.loading = true;
  render();

  // mock API
  setTimeout(() => {
    // success
state.orders.push({
      id: `ORD-${Date.now()}`,
      createdAt: Date.now(),
      archived: false,
      audit: [],
      status: "new",
      items: [...state.cart],
      total: state.cart.reduce(
        (sum, item) => sum + item.price * item.qty,
        0
      )
    });

    saveOrders();

    resetAfterOrder();
    state.view.screen = "success";
    state.ui.loading = false;
    render();
  }, 800);
}    

function resetAfterOrder() {
  state.cart = [];
  state.selectedProduct = null;
  state.view.qty = 1;
}

function logAudit(order, action) {
  if (!Array.isArray(order.audit)) {
    order.audit = [];
  }

  order.audit.push({
    action,
    by: state.admin.user || "unknown",
    at: Date.now()
  });
}

function exportAuditLog(format = "json") {
  if (!requireAdmin({ type: "export_audit", format })) return;

  const meta = getExportMeta();

let audits = state.orders
  .flatMap(o =>
    (o.audit || []).map(a => ({
      ...a,
      orderId: o.id
    }))
  )
  .sort((a, b) => b.at - a.at);


 audits = applyRelativeDateFilter(
   audits,
   state.audit.lastDays
 );


  if (state.audit.filterAction !== "all") {
    audits = audits.filter(a => a.action === state.audit.filterAction);
  }

  if (state.audit.search) {
    audits = audits.filter(a =>
      a.orderId.toLowerCase().includes(state.audit.search) ||
      (a.by || "").toLowerCase().includes(state.audit.search) ||
      a.action.toLowerCase().includes(state.audit.search)
    );
  }

  if (state.audit.fromDate) {
    const from = new Date(state.audit.fromDate).getTime();
    audits = audits.filter(a => a.at >= from);
  }

  if (state.audit.toDate) {
    const to = new Date(state.audit.toDate).getTime() + 86400000;
    audits = audits.filter(a => a.at <= to);
  }

  const data = audits.map(a => ({
    orderId: a.orderId,
    action: a.action,
    by: a.by,
    at: new Date(a.at).toISOString()
  }));

  let blob;
  let filename = `audit-log.${format}`;

  if (format === "csv") {
    const header =
    `# generatedBy=${meta.generatedBy}, generatedAt=${meta.generatedAt}\n` +
    "orderId,action,by,at\n";
    const rows = data.map(d =>
      `${d.orderId},${d.action},${d.by},${d.at}`
    ).join("\n");
    blob = new Blob([header + rows], { type: "text/csv" });
  } else {
    blob = new Blob([JSON.stringify({
    meta,
    records: data
  }, null, 2)], {
      type: "application/json"
    });
  }

  const a = document.createElement("a");
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = filename;
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}
    
function archiveOrder(orderId) {
  if (!requireAdmin({ type: "archive_order", orderId })) return;

  const ok = confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Archive ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ?");
  if (!ok) return;
  
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;

  if (order.status !== "shipped") {
    alert("‚ö†Ô∏è ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Archive ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    return;
  }
  
  logAudit(order, AUDIT_ACTION.ARCHIVE);
  order.archived = true;
  saveOrders();
  alert("üì¶ Order ‡∏ñ‡∏π‡∏Å Archive ‡πÅ‡∏•‡πâ‡∏ß");
  state.view.screen = "admin"; render();
}

function restoreOrder(orderId) {
  if (!requireAdmin({ type: "restore_order", orderId })) return;
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;

  logAudit(order, AUDIT_ACTION.RESTORE);
  order.archived = false;
  saveOrders();
  alert("‚ôªÔ∏è Order ‡∏ñ‡∏π‡∏Å Restore ‡πÅ‡∏•‡πâ‡∏ß");
  state.view.screen = "admin"; render();
} 

function markOrderPaid(orderId) {
  if (!requireAdmin({ type: "mark_paid", orderId })) return;
  const order = state.orders.find(o => o.id === orderId);
  if (!order || order.status !== "new") return;

  logAudit(order, AUDIT_ACTION.MARK_PAID);
  order.status = "paid";
  saveOrders();
  renderAdminOrderDetail();
}

function markOrderShipped(orderId) {
  if (!requireAdmin({ type: "mark_shipped", orderId })) return;
  const order = state.orders.find(o => o.id === orderId);
  if (!order || order.status !== "paid") return;

  logAudit(order, AUDIT_ACTION.MARK_SHIPPED);
  order.status = "shipped";
  saveOrders();
  renderAdminOrderDetail();
}

function printOrder(orderId) {
  if (!requireAdmin({ type: "print_order", orderId })) return;

  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;

  const win = window.open("", "_blank");
  if (!win) return;

  win.document.write(`
    <html>
    <head>
      <title>Order ${order.id}</title>
      <base href="${location.href.replace(/[^/]*$/, "")}">
      <style>
      @font-face {
        font-family: "Sarabun";
        src: url("assets/fonts/THSarabunNew.ttf") format("truetype");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "Sarabun";
        src: url("assets/fonts/THSarabunNew-Bold.ttf") format("truetype");
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
        body { font-family: "Sarabun", Arial, sans-serif; padding: 24px; }
        h1, h2 { margin-bottom: 8px; }
        .section { margin-bottom: 16px; }
        .item, .audit { display: flex; justify-content: space-between; }
        .muted { color: #666; font-size: 12px; }
      </style>
    </head>
    <body>
      <h1>Order ${order.id}</h1>

      <div class="section">
       <strong>Status:</strong> ${order.status}
      </div>

      <div class="section">
        <h2>Items</h2>
        ${order.items.map(i => `
          <div class="item">
            <span>${i.name} x${i.qty}</span>
            <span>${i.price * i.qty}</span>
          </div>
        `).join("")}
        <div><strong>Total:</strong> ${order.total}</div>
      </div>

      <div class="section">
        <h2>Audit Trail</h2>
        ${(order.audit || []).map(a => `
          <div class="audit">
            <span>${a.action}</span>
            <span class="muted">${a.by} @ ${new Date(a.at).toLocaleString()}</span>
          </div>
        `).join("")}
      </div>

      <script>
        window.onload = async () => {
          try {
            if (document.fonts && document.fonts.ready) {
              await document.fonts.ready;
            }
          } catch {}
          window.print();
        };
      <\/script>
    </body>
    </html>
  `);

  win.document.close();
}

function svgToImage(element, width, height) {
  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
     <foreignObject width="100%" height="100%">
      <div xmlns="http://www.w3.org/1999/xhtml">
        ${new XMLSerializer().serializeToString(element)}
      </div>
      </foreignObject>
    </svg>
  `;

  const img = new Image();
  img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  return img;
}

// ===============================
// PNG Capture Helpers (html2canvas)
// ===============================

async function captureElementCanvas(el, opts = {}) {
  if (!el) throw new Error("captureElementCanvas: element not found");
  if (typeof window.html2canvas !== "function") {
    throw new Error("html2canvas not loaded");
  }

  const scale = Number(opts.scale) || 2;
  const bg = opts.backgroundColor ?? "#fff";

  return await window.html2canvas(el, {
    backgroundColor: bg,
    scale,
    useCORS: true,
    allowTaint: false,
    logging: false,
    scrollX: 0,
    // NOTE: offscreen element (left:-9999px) should not depend on window scroll
    scrollY: (opts.ignoreScroll ? 0 : -window.scrollY)
  });
}

function downloadCanvasPNG(canvas, filename) {
  return new Promise(resolve => {
    if (!canvas) return resolve(false);

    canvas.toBlob(blob => {
      if (!blob) return resolve(false);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
      resolve(true);
    }, "image/png");
  });
}
    
function exportAnalyticsPNG() {
  if (!requireAdmin({ type: "export_analytics_png" })) return;

  const section = document.querySelector(".admin-analytics");
  if (!section) return;

  (async () => {
    try {
      // ensure webfont loaded before capture
      if (document.fonts && document.fonts.ready) {
        await document.fonts.ready;
      }
      const scale = Math.max(2, Number(window.devicePixelRatio) || 1);
      const canvas = await captureElementCanvas(section, { scale, backgroundColor: "#fff" });
      await downloadCanvasPNG(canvas, "analytics-snapshot.png");
    } catch (e) {
      console.warn("exportAnalyticsPNG failed", e);
      alert("‚ùå Export PNG ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (html2canvas)");
    }
  })();
}
   
 function exportOrderPDF(orderId, options = {}) {
   if (!requireAdmin({ type: "export_order_pdf", orderId })) return;
   const skipConfirm = !!options.skipConfirm;
   if (!skipConfirm) {
     if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export PDF (A4) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
   }

   const order = state.orders.find(o => o.id === orderId);
   if (!order) return;

   if (order.status !== "shipped") {
     alert("‚ö†Ô∏è ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Export PDF ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß");
     return;
   }

   logAudit(order, AUDIT_ACTION.EXPORT_PDF);

   const meta = getExportMeta();

   const win = window.open("", "_blank");
   if (!win) return;

   win.document.write(`
     <html>
     <head>
       <title>order-${order.id}.pdf</title>
       <base href="${location.href.replace(/[^/]*$/, "")}">
       <style>
       @font-face {
         font-family: "Sarabun";
         src: url("assets/fonts/THSarabunNew.ttf") format("truetype");
         font-weight: 400;
         font-style: normal;
         font-display: swap;
       }
       @font-face {
         font-family: "Sarabun";
         src: url("assets/fonts/THSarabunNew-Bold.ttf") format("truetype");
         font-weight: 700;
         font-style: normal;
         font-display: swap;
       }
         @page {
           size: A4;
           margin: 24mm;
         }

body {
           font-family: "Sarabun", Arial, sans-serif;
           font-size: 12pt;
           color: #000;
           margin: 0;
         }

         /* ===== Print Header / Footer ===== */
         .pdf-header,
         .pdf-footer {
           position: fixed;
           left: 0;
           right: 0;
           color: #555;
           font-size: 10pt;
         }

         .pdf-header {
           top: 0;
           padding: 12mm 24mm 6mm;
           border-bottom: 1px solid #ddd;
         }

         .pdf-footer {
           bottom: 0;
           padding: 6mm 24mm 12mm;
           border-top: 1px solid #ddd;
           display: flex;
           justify-content: space-between;
         }

         .page-number:after {
           content: "Page " counter(page) " / " counter(pages);
         }

         /* content spacing to avoid overlap */
         .pdf-content {
           padding: 32mm 24mm;
         }
         
         .section {
           margin-bottom: 16px;
         }
         .item, .audit {
           display: flex;
           justify-content: space-between;
         }
         .muted {
           color: #666;
           font-size: 10pt;
         }
         
        </style>
     </head>
     <body>
       <div class="pdf-header">
         <strong>Order ${order.id}</strong>
       </div>

       <div class="pdf-footer">
         <div>Printed by: ${state.admin.user || "unknown"}</div>
         <div class="page-number"></div>
       </div>

       <div class="pdf-content">
         <div class="section muted">
           Printed at: ${new Date(meta.generatedAt).toLocaleString()}
           <br/>Generated by: ${meta.generatedBy}
         </div>

         <h1>Order ${order.id}</h1>

       <div class="section">
         <strong>Status:</strong> ${order.status}
       </div>

       <div class="section">
         <h2>Items</h2>
         ${order.items.map(i => `
           <div class="item">
             <span>${i.name} x${i.qty}</span>
             <span>${i.price * i.qty}</span>
           </div>
         `).join("")}
         <div><strong>Total:</strong> ${order.total}</div>
       </div>

       <div class="section">
         <h2>Audit Trail</h2>
         ${(order.audit || []).map(a => `
           <div class="audit">
             <span>${a.action}</span>
             <span class="muted">${a.by} @ ${new Date(a.at).toLocaleString()}</span>
           </div>
         `).join("")}
       </div>

       </div> <!-- /.pdf-content -->  
       <script>
window.onload = async () => {
           try {
             if (document.fonts && document.fonts.ready) {
               await document.fonts.ready;
             }
           } catch {}
           window.print();
         };
       <\/script>
     </body>
     </html>
   `);

   win.document.close();
 }

function toggleBatchOrder(orderId, checked) {
  const list = state.batchSelection.selectedOrderIds;
  if (checked && !list.includes(orderId)) {
    list.push(orderId);
  }
  if (!checked) {
    state.batchSelection.selectedOrderIds =
      list.filter(id => id !== orderId);
  }
}

function toggleBatchShippedOnly(value) {
  state.batchSelection.shippedOnly = value;
  state.batchSelection.selectedOrderIds = [];
  render();
}

 function exportOrdersPDFBatch(orderIds, options = {}) {
  if (!requireAdmin({ type: "export_orders_pdf_batch", orderIds })) return;

  if (!Array.isArray(orderIds) || orderIds.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡πâ Export");
    return;
  }

  const orders = orderIds
    .map(id => state.orders.find(o => o.id === id))
    .filter(Boolean);

  const invalid = orders.filter(o => o.status !== "shipped");
  if (invalid.length > 0) {
    alert("‚ö†Ô∏è ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Export ‡πÑ‡∏î‡πâ");
    return;
  } 

  if (orderIds.length > 10) {
    alert("‚ö†Ô∏è ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£ Export ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
    return;
  }

const skipConfirm = !!options.skipConfirm;
  if (!skipConfirm) {
    const ok = confirm(
      `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export PDF ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${orderIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå)`
    );
    if (!ok) return;
  }

   orders.forEach(o =>
     logAudit(o, AUDIT_ACTION.EXPORT_PDF_BATCH)
   ); 

   saveOrders();

  let index = 0;

  function next() {
    if (index >= orderIds.length) {
      state.batchSelection.selectedOrderIds = [];
      state.view.screen = "admin";
      render();
      alert("üìÑ Export PDF (Batch) ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå");
      return;
    }
const currentId = orderIds[index];
    const go = confirm(`‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(${index + 1}/${orderIds.length})`);
    if (!go) return;

    exportOrderPDF(currentId, { skipConfirm: true });
    index++;

    // STEP 18.29 ‚Äî next file must be triggered by user gesture (confirm above),
    // so call next() immediately (it will ask confirm again)
    next();
  }

  next();
}

   </script>

  <script>
    /* ===============================
       APP BOOTSTRAP
    =============================== */
    
function boot() {
   loadOrders();
   loadAuditFilter();
   loadAuditCollapsedActions();
   loadAnalyticsPrefs();
   loadLastScreen(); // STEP 18.24
   renderHeader();
   render();
 }

 boot();
  </script>

</body>
</html>
